<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="../../">
    <title>å¢å¼ºæ£€ç´¢çš„RAGä¸ä¸Šä¸‹æ–‡æ£€ç´¢</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-folder " data-level="0" >
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">extended_thinking</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="extended_thinking/extended_thinking_with_tool_use_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">æ‰©å±•æ€è€ƒä¸å·¥å…·ä½¿ç”¨</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="extended_thinking/extended_thinking_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">æ‰©å±•æ€è€ƒ</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="0" >
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">finetuning</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="finetuning/finetuning_on_bedrock_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">åœ¨ Bedrock ä¸Šå¾®è°ƒ Claude 3 Haiku</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="0" >
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">misc</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/batch_processing_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">æ‰¹é‡å¤„ç†æ¶ˆæ¯æ‰¹æ¬¡API</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/building_evals_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">å»ºç«‹è¯„ä¼°</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/building_moderation_filter_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">å»ºç«‹ä¸€ä¸ªå¸¦æœ‰ Claude çš„å®¡æ ¸è¿‡æ»¤å™¨</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/generate_test_cases_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">é¦–å…ˆï¼Œæˆ‘ä»¬æœ‰ `extract_variables` å‡½æ•°ï¼Œ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/how_to_enable_json_mode_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">æç¤º Claude è·å–â€œJSON æ¨¡å¼â€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/how_to_make_sql_queries_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">å¦‚ä½•ä½¿ç”¨ Claude è¿›è¡Œ SQL æŸ¥è¯¢</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/illustrated_responses_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Claude çš„å›¾ç¤ºåŒ–å“åº”</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/mc_qa_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">å®éªŒæ€§æµ‹è¯• Claude çš„é•¿ä¸Šä¸‹æ–‡é—®ç­”èƒ½åŠ›</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/metaprompt_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Metaprompt</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/pdf_upload_summarization_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">â€œä¸Šä¼ â€PDF åˆ° Claude API</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/prompt_caching_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¼“å­˜æç¤ºï¼ˆPrompt cachingï¼‰é€šè¿‡ Anthropic API</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/read_web_pages_with_haiku_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ä½¿ç”¨ Claude 3 Haiku æ€»ç»“ç½‘é¡µå†…å®¹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/sampling_past_max_tokens_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Claude ä» Claude ä¹‹å¤–çš„é‡‡æ ·å“åº”ï¼Œè¶…å‡ºæœ€å¤§ä»¤ç‰Œé™åˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/speculative_prompt_caching_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">æŠ•æœºæ€§æç¤ºç¼“å­˜</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/using_citations_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">å¼•è¨€</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="0" >
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">multimodal</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="multimodal/best_practices_for_vision_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="multimodal/getting_started_with_vision_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">å¼€å§‹ä¸Šæ‰‹ - å¦‚ä½•å°†å›¾åƒä¼ é€’ç»™ Claude</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="multimodal/how_to_transcribe_text_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">å¦‚ä½•ä½¿ç”¨ Claude è½¬å½•æ–‡æ¡£</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="multimodal/reading_charts_graphs_powerpoints_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ä½¿ç”¨å›¾è¡¨å’Œå¹»ç¯ç‰‡æ”¾æ˜ </span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="multimodal/using_sub_agents_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ä½¿ç”¨ Haiku ä½œä¸ºå­ä»£ç†</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="0" >
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">patterns</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">agents</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="patterns/agents/basic_workflows_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">é¦–å…ˆä½¿ç”¨å…·æœ‰æ€ç»´é“¾çš„LLMç¡®å®šé€‚å½“çš„è·¯ç”±</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="patterns/agents/evaluator_optimizer_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="patterns/agents/orchestrator_workers_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">æ­¥éª¤1ï¼šè·å–åè°ƒå™¨å“åº”</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="patterns/agents/README_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">æ„å»ºé«˜æ•ˆä»£ç†çš„é£Ÿè°±</span>
                        </a>
                    </div>
                
                    <div class="tree-folder " data-level="2" style="padding-left: 40px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">prompts</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 60px;">
                        <a href="patterns/agents/prompts/citations_agent_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 60px;">
                        <a href="patterns/agents/prompts/research_lead_agent_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 60px;">
                        <a href="patterns/agents/prompts/research_subagent_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </div></div></div></div></div></div>
                    <div class="tree-folder expanded" data-level="0" >
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">skills</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="skills/README_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Claude æŠ€èƒ½</span>
                        </a>
                    </div>
                
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">classification</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="skills/classification/guide_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">è®¾ç½®æˆ‘ä»¬çš„ç¯å¢ƒ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="skills/classification/README_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Claude åˆ†ç±»æŒ‡å—</span>
                        </a>
                    </div>
                
                    <div class="tree-folder " data-level="2" style="padding-left: 40px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">evaluation</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 60px;">
                        <a href="skills/classification/evaluation/README_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ä½¿ç”¨ Promptfoo è¿›è¡Œè¯„ä¼°</span>
                        </a>
                    </div>
                </div></div></div></div>
                    <div class="tree-folder expanded" data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">contextual-embeddings</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item active" style="padding-left: 40px;">
                        <a href="skills/contextual-embeddings/guide_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">å¢å¼ºæ£€ç´¢çš„RAGä¸ä¸Šä¸‹æ–‡æ£€ç´¢</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="skills/contextual-embeddings/README_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç»“åˆä¸Šä¸‹æ–‡åµŒå…¥çš„æ£€ç´¢å¢å¼ºç”Ÿæˆ</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">retrieval_augmented_generation</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="skills/retrieval_augmented_generation/guide_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Retrieval Augmented Generation (RAG)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="skills/retrieval_augmented_generation/README_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                
                    <div class="tree-folder " data-level="2" style="padding-left: 40px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">evaluation</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 60px;">
                        <a href="skills/retrieval_augmented_generation/evaluation/README_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ä½¿ç”¨ Promptfoo è¿›è¡Œè¯„ä¼°</span>
                        </a>
                    </div>
                </div></div></div></div>
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">summarization</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="skills/summarization/guide_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">æ‘˜è¦ä¸ Claude</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="skills/summarization/README_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Claude æ‘˜è¦</span>
                        </a>
                    </div>
                
                    <div class="tree-folder " data-level="2" style="padding-left: 40px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">evaluation</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 60px;">
                        <a href="skills/summarization/evaluation/README_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Promptfoo è¯„ä¼°</span>
                        </a>
                    </div>
                </div></div></div></div>
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">text_to_sql</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="skills/text_to_sql/guide_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Set your Anthropic API key</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="skills/text_to_sql/README_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Claude çš„æ–‡æœ¬åˆ° SQL</span>
                        </a>
                    </div>
                
                    <div class="tree-folder " data-level="2" style="padding-left: 40px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">evaluation</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 60px;">
                        <a href="skills/text_to_sql/evaluation/README_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Promptfoo è¯„ä¼°</span>
                        </a>
                    </div>
                </div></div></div></div></div></div>
                    <div class="tree-folder " data-level="0" >
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">third_party</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">Deepgram</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/Deepgram/prerecorded_audio_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">è½¬å½•æ·±è“éŸ³é¢‘æ–‡ä»¶å¹¶ä½¿ç”¨ Anthropic å‡†å¤‡é¢è¯•é—®é¢˜ï¼</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/Deepgram/README_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Deepgram <> Anthropic Cookbooks</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">LlamaIndex</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/LlamaIndex/Basic_RAG_With_LlamaIndex_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">RAG ç®¡é“ä¸ LlamaIndex</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/LlamaIndex/Multi_Document_Agents_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">å¤šæ–‡æ¡£ä»£ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/LlamaIndex/Multi_Modal_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">å¤šæ¨¡æ€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/LlamaIndex/ReAct_Agent_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ReAct Agent</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/LlamaIndex/README_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">LlamaIndex <> Anthropic Cookbooks</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/LlamaIndex/Router_Query_Engine_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">æ³¨æ„ï¼šè¿™ä»…åœ¨ jupyter notebook ä¸­æ˜¯å¿…éœ€çš„ã€‚</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/LlamaIndex/SubQuestion_Query_Engine_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">SubQuestionQueryEngine</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">MongoDB</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/MongoDB/rag_using_mongodb_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">å¦‚ä½•ä½¿ç”¨ Claude 3 å’Œ MongoDB æ„å»º RAG ç³»ç»Ÿ</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">Pinecone</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/Pinecone/claude_3_rag_agent_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">æ£€æŸ¥ Python ç‰ˆæœ¬</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/Pinecone/rag_using_pinecone_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ä½¿ç”¨ Pinecone è¿›è¡Œæ£€ç´¢å¢å¼ºç”Ÿæˆ</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">VoyageAI</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/VoyageAI/how_to_create_embeddings_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">è¿™å°†è‡ªåŠ¨ä½¿ç”¨ç¯å¢ƒå˜é‡VOYAGE_API_KEYã€‚</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">Wikipedia</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/Wikipedia/wikipedia-search-cookbook_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">è¿­ä»£æœç´¢ç»´åŸºç™¾ç§‘ä¸ Claude</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">WolframAlpha</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/WolframAlpha/using_llm_api_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ä½¿ç”¨ Wolfram Alpha LLM API ä½œä¸º Claude çš„å·¥å…·</span>
                        </a>
                    </div>
                </div></div></div></div>
                    <div class="tree-folder " data-level="0" >
                        <div class="tree-folder-header">
                            <span class="tree-arrow">â–¶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">tool_use</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="tool_use/calculator_tool_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ä½¿ç”¨è®¡ç®—å™¨å·¥å…·ä¸ Claude</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="tool_use/customer_service_agent_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ä½¿ç”¨å®¢æˆ·ç«¯å·¥å…·åˆ›å»ºå®¢æœä»£ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="tool_use/extracting_structured_json_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ä½¿ç”¨ Claude å’Œå·¥å…·ä½¿ç”¨åŠŸèƒ½æå–ç»“æ„åŒ– JSON</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="tool_use/memory_cookbook_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">å®‰è£…ä¾èµ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="tool_use/parallel_tools_claude_3_7_sonnet_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">åœ¨ Claude 3.7 Sonnet ä¸Šå¹¶è¡Œè°ƒç”¨å·¥å…·</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="tool_use/tool_choice_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">é€‰æ‹©å·¥å…·</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="tool_use/tool_use_with_pydantic_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">è®°äº‹å·¥å…·ï¼Œæ”¯æŒ Pydantic å’Œ Anthropic å·¥å…·ä½¿ç”¨</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="tool_use/vision_with_tools_zh.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ä½¿ç”¨ Vision ä¸å·¥å…·</span>
                        </a>
                    </div>
                </div></div></nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="rag">å¢å¼ºæ£€ç´¢çš„RAGä¸ä¸Šä¸‹æ–‡æ£€ç´¢</h1>
<blockquote>
<p>æ³¨æ„ï¼šæœ‰å…³ä¸Šä¸‹æ–‡æ£€ç´¢çš„æ›´å¤šèƒŒæ™¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬åœ¨å„ç§æ•°æ®é›†ä¸Šçš„å…¶ä»–æ€§èƒ½è¯„ä¼°ï¼Œæˆ‘ä»¬å»ºè®®é˜…è¯»æˆ‘ä»¬é…å¥—çš„<a href="https://www.anthropic.com/news/contextual-retrieval">åšå®¢æ–‡ç« </a>ã€‚</p>
</blockquote>
<p>æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰ä½¿Claudeèƒ½å¤Ÿåœ¨æä¾›å“åº”æ—¶åˆ©ç”¨æ‚¨çš„å†…éƒ¨çŸ¥è¯†åº“ã€ä»£ç åº“æˆ–ä»»ä½•å…¶ä»–æ–‡æ¡£è¯­æ–™åº“ã€‚ä¼ä¸šè¶Šæ¥è¶Šå¤šåœ°æ„å»ºRAGåº”ç”¨ç¨‹åºæ¥æ”¹è¿›å®¢æˆ·æ”¯æŒã€é—®ç­”å†…éƒ¨å…¬å¸æ–‡æ¡£ã€è´¢åŠ¡ä¸æ³•å¾‹åˆ†æã€ä»£ç ç”Ÿæˆç­‰å·¥ä½œæµç¨‹ã€‚</p>
<p>åœ¨<a href="https://github.com/anthropics/anthropic-cookbook/blob/main/skills/retrieval_augmented_generation/guide.ipynb">å•ç‹¬çš„æŒ‡å—</a>ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†è®¾ç½®åŸºæœ¬æ£€ç´¢ç³»ç»Ÿï¼Œæ¼”ç¤ºäº†å¦‚ä½•è¯„ä¼°å…¶æ€§èƒ½ï¼Œç„¶åæ¦‚è¿°äº†å‡ ç§æé«˜æ€§èƒ½çš„æŠ€æœ¯ã€‚åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»ä¸€ç§æé«˜æ£€ç´¢æ€§èƒ½çš„æŠ€æœ¯ï¼šä¸Šä¸‹æ–‡åµŒå…¥ã€‚</p>
<p>åœ¨ä¼ ç»Ÿçš„RAGä¸­ï¼Œæ–‡æ¡£é€šå¸¸è¢«åˆ†å‰²æˆæ›´å°çš„å—ä»¥å®ç°é«˜æ•ˆæ£€ç´¢ã€‚è™½ç„¶è¿™ç§æ–¹æ³•å¯¹è®¸å¤šåº”ç”¨ç¨‹åºéƒ½æœ‰æ•ˆï¼Œä½†å½“å•ä¸ªå—ç¼ºä¹è¶³å¤Ÿä¸Šä¸‹æ–‡æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ã€‚ä¸Šä¸‹æ–‡åµŒå…¥é€šè¿‡åœ¨åµŒå…¥æ¯ä¸ªå—ä¹‹å‰æ·»åŠ ç›¸å…³ä¸Šä¸‹æ–‡æ¥è§£å†³æ­¤é—®é¢˜ã€‚è¿™ç§æ–¹æ³•æé«˜äº†æ¯ä¸ªåµŒå…¥å—çš„è´¨é‡ï¼Œä»è€Œå®ç°äº†æ›´å‡†ç¡®çš„æ£€ç´¢ï¼Œè¿›è€Œæé«˜äº†æ•´ä½“æ€§èƒ½ã€‚åœ¨æˆ‘ä»¬æµ‹è¯•çš„æ‰€æœ‰æ•°æ®æºçš„å¹³å‡å€¼æ¥çœ‹ï¼Œä¸Šä¸‹æ–‡åµŒå…¥å°†å‰20ä¸ªå—çš„æ£€ç´¢å¤±è´¥ç‡é™ä½äº†35%ã€‚</p>
<p>åŒæ ·çš„å—ç‰¹å®šä¸Šä¸‹æ–‡ä¹Ÿå¯ä»¥ä¸BM25æœç´¢ä¸€èµ·ä½¿ç”¨ï¼Œä»¥è¿›ä¸€æ­¥æé«˜æ£€ç´¢æ€§èƒ½ã€‚æˆ‘ä»¬åœ¨â€œä¸Šä¸‹æ–‡BM25â€éƒ¨åˆ†ä»‹ç»äº†è¿™é¡¹æŠ€æœ¯ã€‚</p>
<p>åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨9ä¸ªä»£ç åº“çš„æ•°æ®é›†ä½œä¸ºæˆ‘ä»¬çš„çŸ¥è¯†åº“æ¥æ„å»ºå’Œä¼˜åŒ–ä¸Šä¸‹æ–‡æ£€ç´¢ç³»ç»Ÿã€‚æˆ‘ä»¬å°†ä»‹ç»ï¼š</p>
<p>1) è®¾ç½®åŸºæœ¬æ£€ç´¢ç®¡é“ä»¥å»ºç«‹æ€§èƒ½åŸºçº¿ã€‚</p>
<p>2) ä¸Šä¸‹æ–‡åµŒå…¥ï¼šå®ƒæ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆæœ‰æ•ˆï¼Œä»¥åŠæç¤ºç¼“å­˜å¦‚ä½•ä½¿å…¶åœ¨ç”Ÿäº§ç”¨ä¾‹ä¸­å¯è¡Œã€‚</p>
<p>3) å®ç°ä¸Šä¸‹æ–‡åµŒå…¥å¹¶æ¼”ç¤ºæ€§èƒ½æ”¹è¿›ã€‚</p>
<p>4) ä¸Šä¸‹æ–‡BM25ï¼šé€šè¿‡<em>ä¸Šä¸‹æ–‡</em>BM25æ··åˆæœç´¢æé«˜æ€§èƒ½ã€‚</p>
<p>5) é€šè¿‡é‡æ–°æ’åºæé«˜æ€§èƒ½ï¼Œ</p>
<h3 id="_1">è¯„ä¼°æŒ‡æ ‡ä¸æ•°æ®é›†ï¼š</h3>
<p>æˆ‘ä»¬ä½¿ç”¨é¢„åˆ†å—çš„9ä¸ªä»£ç åº“æ•°æ®é›†â€”â€”æ‰€æœ‰è¿™äº›ä»£ç åº“éƒ½å·²æ ¹æ®åŸºæœ¬çš„å­—ç¬¦åˆ†å‰²æœºåˆ¶è¿›è¡Œäº†åˆ†å—ã€‚æˆ‘ä»¬çš„è¯„ä¼°æ•°æ®é›†åŒ…å«248ä¸ªæŸ¥è¯¢â€”â€”æ¯ä¸ªæŸ¥è¯¢éƒ½åŒ…å«ä¸€ä¸ªâ€œé»„é‡‘å—â€ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ä¸€ç§ç§°ä¸ºPass@kçš„æŒ‡æ ‡æ¥è¯„ä¼°æ€§èƒ½ã€‚Pass@kæ£€æŸ¥åœ¨ä¸ºæ¯ä¸ªæŸ¥è¯¢æ£€ç´¢åˆ°çš„å‰kä¸ªæ–‡æ¡£ä¸­æ˜¯å¦å­˜åœ¨â€œé»„é‡‘æ–‡æ¡£â€ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸Šä¸‹æ–‡åµŒå…¥å¸®åŠ©æˆ‘ä»¬å°†Pass@10æ€§èƒ½ä»çº¦87%æé«˜åˆ°çº¦95%ã€‚</p>
<p>æ‚¨å¯ä»¥åœ¨<code>data/codebase_chunks.json</code>ä¸­æ‰¾åˆ°ä»£ç æ–‡ä»¶åŠå…¶å—ï¼Œåœ¨<code>data/evaluation_set.jsonl</code>ä¸­æ‰¾åˆ°è¯„ä¼°æ•°æ®é›†ã€‚</p>
<h4 id="_2">é™„åŠ è¯´æ˜ï¼š</h4>
<p>æç¤ºç¼“å­˜æœ‰åŠ©äºç®¡ç†æ­¤æ£€ç´¢æ–¹æ³•çš„æˆæœ¬ã€‚æ­¤åŠŸèƒ½ç›®å‰åœ¨Anthropicçš„1P APIä¸Šå¯ç”¨ï¼Œå¹¶å³å°†ç™»é™†AWS Bedrockå’ŒGCP Vertexä¸­çš„3Påˆä½œä¼™ä¼´ç¯å¢ƒã€‚æˆ‘ä»¬çŸ¥é“è®¸å¤šå®¢æˆ·åœ¨æ„å»ºRAGè§£å†³æ–¹æ¡ˆæ—¶ä¼šåˆ©ç”¨AWSçŸ¥è¯†åº“å’ŒGCP Vertex AI APIï¼Œå¹¶ä¸”æ­¤æ–¹æ³•å¯ä»¥åœ¨ä»»ä¸€å¹³å°ä¸Šä½¿ç”¨ï¼Œåªéœ€ç¨ä½œå®šåˆ¶ã€‚è€ƒè™‘è”ç³»Anthropicæˆ–æ‚¨çš„AWS/GCPå®¢æˆ·å›¢é˜Ÿä»¥è·å–æŒ‡å¯¼ï¼</p>
<p>ä¸ºäº†æ–¹ä¾¿åœ¨Bedrockä¸Šä½¿ç”¨æ­¤æ–¹æ³•ï¼ŒAWSå›¢é˜Ÿä¸ºæˆ‘ä»¬æä¾›äº†ä»£ç ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥å®ç°ä¸€ä¸ªLambdaå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸ºæ¯ä¸ªæ–‡æ¡£æ·»åŠ ä¸Šä¸‹æ–‡ã€‚å¦‚æœæ‚¨éƒ¨ç½²æ­¤Lambdaå‡½æ•°ï¼Œå¯ä»¥åœ¨é…ç½®<a href="https://docs.aws.amazon.com/bedrock/latest/userguide/knowledge-base-create.html">BedrockçŸ¥è¯†åº“</a>æ—¶é€‰æ‹©å®ƒä½œä¸ºè‡ªå®šä¹‰åˆ†å—é€‰é¡¹ã€‚æ‚¨å¯ä»¥åœ¨<code>contextual-rag-lambda-function</code>ä¸­æ‰¾åˆ°æ­¤ä»£ç ã€‚ä¸»è¦çš„Lambdaå‡½æ•°ä»£ç åœ¨<code>lambda_function.py</code>ä¸­ã€‚</p>
<h2 id="_3">ç›®å½•</h2>
<p>1) è®¾ç½®</p>
<p>2) åŸºæœ¬RAG</p>
<p>3) ä¸Šä¸‹æ–‡åµŒå…¥</p>
<p>4) ä¸Šä¸‹æ–‡BM25</p>
<p>5) é‡æ–°æ’åº</p>
<h2 id="_4">è®¾ç½®</h2>
<p>æˆ‘ä»¬éœ€è¦ä¸€äº›åº“ï¼ŒåŒ…æ‹¬ï¼š</p>
<p>1) <code>anthropic</code> - ç”¨äºä¸Claudeäº¤äº’</p>
<p>2) <code>voyageai</code> - ç”¨äºç”Ÿæˆé«˜è´¨é‡åµŒå…¥</p>
<p>3) <code>cohere</code> - ç”¨äºé‡æ–°æ’åº</p>
<p>4) <code>elasticsearch</code> ç”¨äºé«˜æ€§èƒ½BM25æœç´¢</p>
<p>3) <code>pandas</code>ã€<code>numpy</code>ã€<code>matplotlib</code>å’Œ<code>scikit-learn</code>ç”¨äºæ•°æ®æ“ä½œå’Œå¯è§†åŒ–</p>
<p>æ‚¨è¿˜éœ€è¦æ¥è‡ª<a href="https://www.anthropic.com/">Anthropic</a>ã€<a href="https://www.voyageai.com/">Voyage AI</a>å’Œ<a href="https://cohere.com/rerank">Cohere</a>çš„APIå¯†é’¥</p>
<pre class="codehilite"><code class="language-python">!pip install anthropic
!pip install voyageai
!pip install cohere
!pip install elasticsearch
!pip install pandas
!pip install numpy
</code></pre>

<pre class="codehilite"><code class="language-python">import os

os.environ['VOYAGE_API_KEY'] = &quot;YOUR KEY HERE&quot;
os.environ['ANTHROPIC_API_KEY'] = &quot;YOUR KEY HERE&quot;
os.environ['COHERE_API_KEY'] = &quot;YOUR KEY HERE&quot;
</code></pre>

<pre class="codehilite"><code class="language-python">import anthropic

client = anthropic.Anthropic(
    # This is the default and can be omitted
    api_key=os.getenv(&quot;ANTHROPIC_API_KEY&quot;),
)
</code></pre>

<h3 id="_5">åˆå§‹åŒ–å‘é‡æ•°æ®åº“ç±»</h3>
<p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å†…å­˜ä¸­çš„å‘é‡æ•°æ®åº“ï¼Œä½†å¯¹äºç”Ÿäº§åº”ç”¨ç¨‹åºï¼Œæ‚¨å¯èƒ½å¸Œæœ›ä½¿ç”¨æ‰˜ç®¡è§£å†³æ–¹æ¡ˆã€‚ </p>
<pre class="codehilite"><code class="language-python">import os
import pickle
import json
import numpy as np
import voyageai
from typing import List, Dict, Any
from tqdm import tqdm

class VectorDB:
    def __init__(self, name: str, api_key = None):
        if api_key is None:
            api_key = os.getenv(&quot;VOYAGE_API_KEY&quot;)
        self.client = voyageai.Client(api_key=api_key)
        self.name = name
        self.embeddings = []
        self.metadata = []
        self.query_cache = {}
        self.db_path = f&quot;./data/{name}/vector_db.pkl&quot;

    def load_data(self, dataset: List[Dict[str, Any]]):
        if self.embeddings and self.metadata:
            print(&quot;Vector database is already loaded. Skipping data loading.&quot;)
            return
        if os.path.exists(self.db_path):
            print(&quot;Loading vector database from disk.&quot;)
            self.load_db()
            return

        texts_to_embed = []
        metadata = []
        total_chunks = sum(len(doc['chunks']) for doc in dataset)

        with tqdm(total=total_chunks, desc=&quot;Processing chunks&quot;) as pbar:
            for doc in dataset:
                for chunk in doc['chunks']:
                    texts_to_embed.append(chunk['content'])
                    metadata.append({
                        'doc_id': doc['doc_id'],
                        'original_uuid': doc['original_uuid'],
                        'chunk_id': chunk['chunk_id'],
                        'original_index': chunk['original_index'],
                        'content': chunk['content']
                    })
                    pbar.update(1)

        self._embed_and_store(texts_to_embed, metadata)
        self.save_db()

        print(f&quot;Vector database loaded and saved. Total chunks processed: {len(texts_to_embed)}&quot;)

    def _embed_and_store(self, texts: List[str], data: List[Dict[str, Any]]):
        batch_size = 128
        with tqdm(total=len(texts), desc=&quot;Embedding chunks&quot;) as pbar:
            result = []
            for i in range(0, len(texts), batch_size):
                batch = texts[i : i + batch_size]
                batch_result = self.client.embed(batch, model=&quot;voyage-2&quot;).embeddings
                result.extend(batch_result)
                pbar.update(len(batch))

        self.embeddings = result
        self.metadata = data

    def search(self, query: str, k: int = 20) -&gt; List[Dict[str, Any]]:
        if query in self.query_cache:
            query_embedding = self.query_cache[query]
        else:
            query_embedding = self.client.embed([query], model=&quot;voyage-2&quot;).embeddings[0]
            self.query_cache[query] = query_embedding

        if not self.embeddings:
            raise ValueError(&quot;No data loaded in the vector database.&quot;)

        similarities = np.dot(self.embeddings, query_embedding)
        top_indices = np.argsort(similarities)[::-1][:k]

        top_results = []
        for idx in top_indices:
            result = {
                &quot;metadata&quot;: self.metadata[idx],
                &quot;similarity&quot;: float(similarities[idx]),
            }
            top_results.append(result)

        return top_results

    def save_db(self):
        data = {
            &quot;embeddings&quot;: self.embeddings,
            &quot;metadata&quot;: self.metadata,
            &quot;query_cache&quot;: json.dumps(self.query_cache),
        }
        os.makedirs(os.path.dirname(self.db_path), exist_ok=True)
        with open(self.db_path, &quot;wb&quot;) as file:
            pickle.dump(data, file)

    def load_db(self):
        if not os.path.exists(self.db_path):
            raise ValueError(&quot;Vector database file not found. Use load_data to create a new database.&quot;)
        with open(self.db_path, &quot;rb&quot;) as file:
            data = pickle.load(file)
        self.embeddings = data[&quot;embeddings&quot;]
        self.metadata = data[&quot;metadata&quot;]
        self.query_cache = json.loads(data[&quot;query_cache&quot;])

    def validate_embedded_chunks(self):
        unique_contents = set()
        for meta in self.metadata:
            unique_contents.add(meta['content'])

        print(f&quot;Validation results:&quot;)
        print(f&quot;Total embedded chunks: {len(self.metadata)}&quot;)
        print(f&quot;Unique embedded contents: {len(unique_contents)}&quot;)

        if len(self.metadata) != len(unique_contents):
            print(&quot;Warning: There may be duplicate chunks in the embedded data.&quot;)
        else:
            print(&quot;All embedded chunks are unique.&quot;)
</code></pre>

<pre class="codehilite"><code class="language-python"># Load your transformed dataset
with open('data/codebase_chunks.json', 'r') as f:
    transformed_dataset = json.load(f)

# Initialize the VectorDB
base_db = VectorDB(&quot;base_db&quot;)

# Load and process the data
base_db.load_data(transformed_dataset)
</code></pre>

<h2 id="rag_1">åŸºæœ¬RAG</h2>
<p>ä¸ºäº†å¼€å§‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ç§æœ€åŸºæœ¬çš„æ–¹æ³•æ¥è®¾ç½®ä¸€ä¸ªåŸºæœ¬çš„RAGç®¡é“ã€‚è¿™æœ‰æ—¶è¢«ç§°ä¸ºè¡Œä¸šä¸­çš„â€œæœ´ç´ RAGâ€ã€‚ä¸€ä¸ªåŸºæœ¬çš„RAGç®¡é“åŒ…æ‹¬ä»¥ä¸‹3ä¸ªæ­¥éª¤ï¼š</p>
<p>1) æŒ‰æ ‡é¢˜åˆ†å—æ–‡æ¡£ - åªåŒ…å«æ¯ä¸ªå­æ ‡é¢˜çš„å†…å®¹</p>
<p>2) åµŒå…¥æ¯ä¸ªæ–‡æ¡£</p>
<p>3) ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦æ£€ç´¢æ–‡æ¡£ä»¥å›ç­”æŸ¥è¯¢</p>
<pre class="codehilite"><code class="language-python">import json
from typing import List, Dict, Any, Callable, Union
from tqdm import tqdm

def load_jsonl(file_path: str) -&gt; List[Dict[str, Any]]:
    &quot;&quot;&quot;åŠ è½½JSONLæ–‡ä»¶å¹¶è¿”å›å­—å…¸åˆ—è¡¨ã€‚&quot;&quot;&quot;
    with open(file_path, 'r') as file:
        return [json.loads(line) for line in file]

def evaluate_retrieval(queries: List[Dict[str, Any]], retrieval_function: Callable, db, k: int = 20) -&gt; Dict[str, float]:
    total_score = 0
    total_queries = len(queries)

    for query_item in tqdm(queries, desc=&quot;Evaluating retrieval&quot;):
        query = query_item['query']
        golden_chunk_uuids = query_item['golden_chunk_uuids']

        # æŸ¥æ‰¾æ‰€æœ‰é»„é‡‘å—å†…å®¹
        golden_contents = []
        for doc_uuid, chunk_index in golden_chunk_uuids:
            golden_doc = next((doc for doc in query_item['golden_documents'] if doc['uuid'] == doc_uuid), None)
            if not golden_doc:
                print(f&quot;è­¦å‘Šï¼šæ‰¾ä¸åˆ°UUID {doc_uuid} çš„é»„é‡‘æ–‡æ¡£&quot;)
                continue

            golden_chunk = next((chunk for chunk in golden_doc['chunks'] if chunk['index'] == chunk_index), None)
            if not golden_chunk:
                print(f&quot;è­¦å‘Šï¼šåœ¨æ–‡æ¡£ {doc_uuid} ä¸­æ‰¾ä¸åˆ°ç´¢å¼• {chunk_index} çš„é»„é‡‘å—&quot;)
                continue

            golden_contents.append(golden_chunk['content'].strip())

        if not golden_contents:
            print(f&quot;è­¦å‘Šï¼šæœªæ‰¾åˆ°æŸ¥è¯¢çš„é»„é‡‘å†…å®¹ï¼š{query}&quot;)
            continue

        retrieved_docs = retrieval_function(query, db, k=k)

        # è®¡ç®—æ£€ç´¢åˆ°çš„å‰kä¸ªæ–‡æ¡£ä¸­æœ‰å¤šå°‘ä¸ªé»„é‡‘å—
        chunks_found = 0
        for golden_content in golden_contents:
            for doc in retrieved_docs[:k]:
                retrieved_content = doc['metadata'].get('original_content', doc['metadata'].get('content', '')).strip()
                if retrieved_content == golden_content:
                    chunks_found += 1
                    break

        query_score = chunks_found / len(golden_contents)
        total_score += query_score

    average_score = total_score / total_queries
    pass_at_n = average_score * 100
    return {
        &quot;pass_at_n&quot;: pass_at_n,
        &quot;average_score&quot;: average_score,
        &quot;total_queries&quot;: total_queries
    }

def retrieve_base(query: str, db, k: int = 20) -&gt; List[Dict[str, Any]]:
    &quot;&quot;&quot;
    ä½¿ç”¨VectorDBæˆ–ContextualVectorDBæ£€ç´¢ç›¸å…³æ–‡æ¡£ã€‚

    :param query: æŸ¥è¯¢å­—ç¬¦ä¸²
    :param db: VectorDBæˆ–ContextualVectorDBå®ä¾‹
    :param k: è¦æ£€ç´¢çš„å‰kä¸ªç»“æœçš„æ•°é‡
    :return: æ£€ç´¢åˆ°çš„æ–‡æ¡£åˆ—è¡¨
    &quot;&quot;&quot;
    return db.search(query, k=k)

def evaluate_db(db, original_jsonl_path: str, k):
    # åŠ è½½åŸå§‹JSONLæ•°æ®ç”¨äºæŸ¥è¯¢å’Œåœ°é¢çœŸå®
    original_data = load_jsonl(original_jsonl_path)

    # è¯„ä¼°æ£€ç´¢
    results = evaluate_retrieval(original_data, retrieve_base, db, k)
    print(f&quot;Pass@{k}: {results['pass_at_n']:.2f}%&quot;)
    print(f&quot;Total Score: {results['average_score']}&quot;)
    print(f&quot;Total queries: {results['total_queries']}&quot;)
</code></pre>

<pre class="codehilite"><code class="language-python">results5 = evaluate_db(base_db, 'data/evaluation_set.jsonl', 5)
results10 = evaluate_db(base_db, 'data/evaluation_set.jsonl', 10)
results20 = evaluate_db(base_db, 'data/evaluation_set.jsonl', 20)
</code></pre>

<pre class="codehilite"><code>Evaluating retrieval: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 248/248 [00:06&lt;00:00, 40.70it/s]


Pass@5: 80.92%
Total Score: 0.8091877880184332
Total queries: 248


Evaluating retrieval: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 248/248 [00:06&lt;00:00, 39.50it/s]


Pass@10: 87.15%
Total Score: 0.8714957757296468
Total queries: 248


Evaluating retrieval: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 248/248 [00:06&lt;00:00, 39.43it/s]

Pass@20: 90.06%
Total Score: 0.9006336405529954
Total queries: 248
</code></pre>

<h2 id="_6">ä¸Šä¸‹æ–‡åµŒå…¥</h2>
<p>é€šè¿‡åŸºæœ¬RAGï¼Œæ¯ä¸ªåµŒå…¥çš„å—éƒ½åŒ…å«å¯èƒ½æœ‰ç”¨ä¿¡æ¯ï¼Œä½†è¿™äº›å—ç¼ºä¹ä¸Šä¸‹æ–‡ã€‚é€šè¿‡ä¸Šä¸‹æ–‡åµŒå…¥ï¼Œæˆ‘ä»¬é€šè¿‡åœ¨åµŒå…¥æ¯ä¸ªæ–‡æœ¬å—ä¹‹å‰æ·»åŠ æ›´å¤šä¸Šä¸‹æ–‡æ¥åˆ›å»ºåµŒå…¥æœ¬èº«çš„å˜ä½“ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬ä½¿ç”¨Claudeä¸ºæ¯ä¸ªå—åˆ›å»ºä¸€ä¸ªç®€æ´çš„ä¸Šä¸‹æ–‡ï¼Œè§£é‡Šè¯¥å—ï¼Œå¹¶åˆ©ç”¨æ•´ä¸ªæ–‡æ¡£çš„ä¸Šä¸‹æ–‡ã€‚åœ¨æˆ‘ä»¬çš„ä»£ç åº“æ•°æ®é›†çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†å—å’Œæ¯ä¸ªå—æ‰€åœ¨çš„æ•´ä¸ªæ–‡ä»¶æä¾›ç»™LLMï¼Œç„¶åç”Ÿæˆä¸Šä¸‹æ–‡ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†æ­¤â€œä¸Šä¸‹æ–‡â€å’ŒåŸå§‹æ–‡æœ¬å—ç»„åˆæˆä¸€ä¸ªå•ä¸€çš„æ–‡æœ¬å—ï¼Œç„¶åå†åˆ›å»ºæ¯ä¸ªåµŒå…¥ã€‚</p>
<h3 id="_7">å…¶ä»–è€ƒè™‘å› ç´ ï¼šæˆæœ¬å’Œå»¶è¿Ÿ</h3>
<p>æˆ‘ä»¬ä¸ºâ€œå®šä½â€æ¯ä¸ªæ–‡æ¡£æ‰€åšçš„é¢å¤–å·¥ä½œä»…åœ¨æ‘„å–æ—¶å‘ç”Ÿï¼šè¿™æ˜¯æ‚¨å­˜å‚¨æ¯ä¸ªæ–‡æ¡£æ—¶ï¼ˆä»¥åŠå°†æ¥å¦‚æœæ‚¨çš„çŸ¥è¯†åº“æ›´æ–°æ—¶ï¼‰éœ€è¦æ”¯ä»˜ä¸€æ¬¡çš„æˆæœ¬ã€‚æœ‰è®¸å¤šæ–¹æ³•ï¼Œå¦‚HyDEï¼ˆå‡è®¾æ–‡æ¡£åµŒå…¥ï¼‰ï¼Œæ¶‰åŠåœ¨æ‰§è¡Œæœç´¢ä¹‹å‰æ‰§è¡Œæ­¥éª¤æ¥æ”¹è¿›æŸ¥è¯¢çš„è¡¨ç¤ºã€‚è¿™äº›æŠ€æœ¯å·²è¢«è¯æ˜å…·æœ‰ä¸­ç­‰æ•ˆæœï¼Œä½†å®ƒä»¬ä¼šæ˜¾è‘—å¢åŠ è¿è¡Œæ—¶çš„å»¶è¿Ÿã€‚</p>
<p><a href="https://docs.anthropic.com/en/docs/build-with-claude/prompt-caching">æç¤ºç¼“å­˜</a>ä¹Ÿä½¿å…¶æ›´å…·æˆæœ¬æ•ˆç›Šã€‚åˆ›å»ºä¸Šä¸‹æ–‡åµŒå…¥éœ€è¦æˆ‘ä»¬å°†ç›¸åŒçš„æ–‡æ¡£ä¼ é€’ç»™æ¨¡å‹ï¼Œä»¥è·å–æˆ‘ä»¬æƒ³è¦ç”Ÿæˆé¢å¤–ä¸Šä¸‹æ–‡çš„æ¯ä¸ªå—ã€‚é€šè¿‡æç¤ºç¼“å­˜ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ•´ä¸ªæ–‡æ¡£å†™å…¥ç¼“å­˜ä¸€æ¬¡ï¼Œç„¶åå› ä¸ºæˆ‘ä»¬æŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰æ‘„å–å·¥ä½œï¼Œæ‰€ä»¥å¯ä»¥åœ¨ç”Ÿæˆè¯¥æ–‡æ¡£å†…æ¯ä¸ªå—çš„ä¸Šä¸‹æ–‡æ—¶ä»ç¼“å­˜ä¸­è¯»å–æ–‡æ¡£ï¼ˆæ‚¨å†™å…¥ç¼“å­˜çš„ä¿¡æ¯æœ‰5åˆ†é’Ÿçš„ç”Ÿå­˜æ—¶é—´ï¼‰ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬ç¬¬ä¸€æ¬¡å°†æ–‡æ¡£ä¼ é€’ç»™æ¨¡å‹æ—¶ï¼Œæˆ‘ä»¬ä¼šæ”¯ä»˜ç¨å¤šä¸€ç‚¹çš„è´¹ç”¨å°†å…¶å†™å…¥ç¼“å­˜ï¼Œä½†å¯¹äºåŒ…å«è¯¥æ–‡æ¡£çš„æ¯ä¸ªåç»­APIè°ƒç”¨ï¼Œæˆ‘ä»¬å°†è·å¾—90%çš„ç¼“å­˜è¯»å–è¾“å…¥ä»¤ç‰ŒæŠ˜æ‰£ã€‚å‡è®¾800ä¸ªä»¤ç‰Œå—ï¼Œ8kä¸ªä»¤ç‰Œæ–‡æ¡£ï¼Œ50ä¸ªä»¤ç‰Œä¸Šä¸‹æ–‡æŒ‡ä»¤ï¼Œä»¥åŠæ¯ä¸ªå—100ä¸ªä»¤ç‰Œçš„ä¸Šä¸‹æ–‡ï¼Œåˆ™ç”Ÿæˆä¸Šä¸‹æ–‡åŒ–å—çš„æˆæœ¬ä¸ºæ¯ç™¾ä¸‡ä¸ªæ–‡æ¡£ä»¤ç‰Œ1.02ç¾å…ƒã€‚</p>
<p>å½“æ‚¨åœ¨ä¸‹é¢å°†æ•°æ®åŠ è½½åˆ°ContextualVectorDBæ—¶ï¼Œæ‚¨å°†åœ¨æ—¥å¿—ä¸­çœ‹åˆ°è¿™ç§å½±å“æœ‰å¤šå¤§ã€‚ </p>
<p>è­¦å‘Šï¼šä¸€äº›è¾ƒå°çš„åµŒå…¥æ¨¡å‹å…·æœ‰å›ºå®šçš„è¾“å…¥ä»¤ç‰Œé™åˆ¶ã€‚ä¸Šä¸‹æ–‡åŒ–å—ä¼šä½¿å…¶å˜é•¿ï¼Œå› æ­¤å¦‚æœæ‚¨æ³¨æ„åˆ°ä¸Šä¸‹æ–‡åŒ–åµŒå…¥çš„æ€§èƒ½æ˜æ˜¾å˜å·®ï¼Œåˆ™ä¸Šä¸‹æ–‡åŒ–å—å¾ˆå¯èƒ½è¢«æˆªæ–­äº†</p>
<pre class="codehilite"><code class="language-python">DOCUMENT_CONTEXT_PROMPT = &quot;&quot;&quot;
&lt;document&gt;
{doc_content}
&lt;/document&gt;
&quot;&quot;&quot;

CHUNK_CONTEXT_PROMPT = &quot;&quot;&quot;
è¿™æ˜¯æˆ‘ä»¬æƒ³è¦åœ¨æ•´ä¸ªæ–‡æ¡£ä¸­å®šä½çš„å—
&lt;chunk&gt;
{chunk_content}
&lt;/chunk&gt;

è¯·æä¾›ä¸€ä¸ªç®€çŸ­çš„ä¸Šä¸‹æ–‡æ¥å°†æ­¤å—å®šä½åœ¨æ•´ä¸ªæ–‡æ¡£ä¸­ï¼Œä»¥æ”¹è¿›å—çš„æœç´¢æ£€ç´¢ã€‚
åªå›ç­”ç®€æ´çš„ä¸Šä¸‹æ–‡ï¼Œä¸è¦å›ç­”å…¶ä»–ä»»ä½•å†…å®¹ã€‚
&quot;&quot;&quot;

def situate_context(doc: str, chunk: str) -&gt; str:
    response = client.beta.prompt_caching.messages.create(
        model=&quot;claude-3-haiku-20240307&quot;,
        max_tokens=1024,
        temperature=0.0,
        messages=[
            {
                &quot;role&quot;: &quot;user&quot;, 
                &quot;content&quot;: [
                    {
                        &quot;type&quot;: &quot;text&quot;,
                        &quot;text&quot;: DOCUMENT_CONTEXT_PROMPT.format(doc_content=doc),
                        &quot;cache_control&quot;: {&quot;type&quot;: &quot;ephemeral&quot;} #æˆ‘ä»¬å°†ä¸ºæ•´ä¸ªæ–‡æ¡£åˆ©ç”¨æç¤ºç¼“å­˜
                    },
                    {
                        &quot;type&quot;: &quot;text&quot;,
                        &quot;text&quot;: CHUNK_CONTEXT_PROMPT.format(chunk_content=chunk),
                    }
                ]
            }
        ],
        extra_headers={&quot;anthropic-beta&quot;: &quot;prompt-caching-2024-07-31&quot;}
    )
    return response

# ç¤ºä¾‹ç”¨æ³•
doc_content = jsonl_data[0]['golden_documents'][0]['content']
chunk_content = jsonl_data[0]['golden_chunks'][0]['content']

response = situate_context(doc_content, chunk_content)
print(f&quot;Situated context: {response.content[0].text}&quot;)

# æ‰“å°ç¼“å­˜æ€§èƒ½æŒ‡æ ‡
print(f&quot;Input tokens: {response.usage.input_tokens}&quot;)
print(f&quot;Output tokens: {response.usage.output_tokens}&quot;)
print(f&quot;Cache creation input tokens: {response.usage.cache_creation_input_tokens}&quot;)
print(f&quot;Cache read input tokens: {response.usage.cache_read_input_tokens}&quot;)
</code></pre>

<pre class="codehilite"><code>Situated context: This chunk describes the `DiffExecutor` struct, which is an executor for differential fuzzing. It wraps two executors that are run sequentially with the same input, and also runs the secondary executor in the `run_target` method.
Input tokens: 366
Output tokens: 55
Cache creation input tokens: 3046
Cache read input tokens: 0
</code></pre>

<pre class="codehilite"><code class="language-python">import os
import pickle
import json
import numpy as np
import voyageai
from typing import List, Dict, Any
from tqdm import tqdm
import anthropic
import threading
import time
from concurrent.futures import ThreadPoolExecutor, as_completed

class ContextualVectorDB:
    def __init__(self, name: str, voyage_api_key=None, anthropic_api_key=None):
        if voyage_api_key is None:
            voyage_api_key = os.getenv(&quot;VOYAGE_API_KEY&quot;)
        if anthropic_api_key is None:
            anthropic_api_key = os.getenv(&quot;ANTHROPIC_API_KEY&quot;)

        self.voyage_client = voyageai.Client(api_key=voyage_api_key)
        self.anthropic_client = anthropic.Anthropic(api_key=anthropic_api_key)
        self.name = name
        self.embeddings = []
        self.metadata = []
        self.query_cache = {}
        self.db_path = f&quot;./data/{name}/contextual_vector_db.pkl&quot;

        self.token_counts = {
            'input': 0,
            'output': 0,
            'cache_read': 0,
            'cache_creation': 0
        }
        self.token_lock = threading.Lock()

    def situate_context(self, doc: str, chunk: str) -&gt; tuple[str, Any]:
        DOCUMENT_CONTEXT_PROMPT = &quot;&quot;&quot;
        &lt;document&gt;
        {doc_content}
        &lt;/document&gt;
        &quot;&quot;&quot;

        CHUNK_CONTEXT_PROMPT = &quot;&quot;&quot;
        è¿™æ˜¯æˆ‘ä»¬æƒ³è¦åœ¨æ•´ä¸ªæ–‡æ¡£ä¸­å®šä½çš„å—
        &lt;chunk&gt;
        {chunk_content}
        &lt;/chunk&gt;

        è¯·æä¾›ä¸€ä¸ªç®€çŸ­çš„ä¸Šä¸‹æ–‡æ¥å°†æ­¤å—å®šä½åœ¨æ•´ä¸ªæ–‡æ¡£ä¸­ï¼Œä»¥æ”¹è¿›å—çš„æœç´¢æ£€ç´¢ã€‚
        åªå›ç­”ç®€æ´çš„ä¸Šä¸‹æ–‡ï¼Œä¸è¦å›ç­”å…¶ä»–ä»»ä½•å†…å®¹ã€‚
        &quot;&quot;&quot;

        response = self.anthropic_client.beta.prompt_caching.messages.create(
            model=&quot;claude-3-haiku-20240307&quot;,
            max_tokens=1000,
            temperature=0.0,
            messages=[
                {
                    &quot;role&quot;: &quot;user&quot;, 
                    &quot;content&quot;: [
                        {
                            &quot;type&quot;: &quot;text&quot;,
                            &quot;text&quot;: DOCUMENT_CONTEXT_PROMPT.format(doc_content=doc),
                            &quot;cache_control&quot;: {&quot;type&quot;: &quot;ephemeral&quot;} #æˆ‘ä»¬å°†åœ¨æ•´ä¸ªæ–‡æ¡£ä¸­ä½¿ç”¨æç¤ºç¼“å­˜
                        },
                        {
                            &quot;type&quot;: &quot;text&quot;,
                            &quot;text&quot;: CHUNK_CONTEXT_PROMPT.format(chunk_content=chunk),
                        },
                    ]
                },
            ],
            extra_headers={&quot;anthropic-beta&quot;: &quot;prompt-caching-2024-07-31&quot;}
        )
        return response.content[0].text, response.usage

    def load_data(self, dataset: List[Dict[str, Any]], parallel_threads: int = 1):
        if self.embeddings and self.metadata:
            print(&quot;Vector database is already loaded. Skipping data loading.&quot;)
            return
        if os.path.exists(self.db_path):
            print(&quot;Loading vector database from disk.&quot;)
            self.load_db()
            return

        texts_to_embed = []
        metadata = []
        total_chunks = sum(len(doc['chunks']) for doc in dataset)

        def process_chunk(doc, chunk):
            #å¯¹äºæ¯ä¸ªå—ï¼Œç”Ÿæˆä¸Šä¸‹æ–‡
            contextualized_text, usage = self.situate_context(doc['content'], chunk['content'])
            with self.token_lock:
                self.token_counts['input'] += usage.input_tokens
                self.token_counts['output'] += usage.output_tokens
                self.token_counts['cache_read'] += usage.cache_read_input_tokens
                self.token_counts['cache_creation'] += usage.cache_creation_input_tokens

            return {
                #å°†ä¸Šä¸‹æ–‡é™„åŠ åˆ°åŸå§‹æ–‡æœ¬å—
                'text_to_embed': f&quot;{chunk['content']}\n\n{contextualized_text}&quot;,
                'metadata': {
                    'doc_id': doc['doc_id'],
                    'original_uuid': doc['original_uuid'],
                    'chunk_id': chunk['chunk_id'],
                    'original_index': chunk['original_index'],
                    'original_content': chunk['content'],
                    'contextualized_content': contextualized_text
                }
            }

        print(f&quot;Processing {total_chunks} chunks with {parallel_threads} threads&quot;)
        with ThreadPoolExecutor(max_workers=parallel_threads) as executor:
            futures = []
            for doc in dataset:
                for chunk in doc['chunks']:
                    futures.append(executor.submit(process_chunk, doc, chunk))

            for future in tqdm(as_completed(futures), total=total_chunks, desc=&quot;Processing chunks&quot;):
                result = future.result()
                texts_to_embed.append(result['text_to_embed'])
                metadata.append(result['metadata'])

        self._embed_and_store(texts_to_embed, metadata)
        self.save_db()

        #è®°å½•ä»¤ç‰Œä½¿ç”¨æƒ…å†µ
        print(f&quot;Contextual Vector database loaded and saved. Total chunks processed: {len(texts_to_embed)}&quot;)
        print(f&quot;Total input tokens without caching: {self.token_counts['input']}&quot;)
        print(f&quot;Total output tokens: {self.token_counts['output']}&quot;)
        print(f&quot;Total input tokens written to cache: {self.token_counts['cache_creation']}&quot;)
        print(f&quot;Total input tokens read from cache: {self.token_counts['cache_read']}&quot;)

        total_tokens = self.token_counts['input'] + self.token_counts['cache_read'] + self.token_counts['cache_creation']
        savings_percentage = (self.token_counts['cache_read'] / total_tokens) * 100 if total_tokens &gt; 0 else 0
        print(f&quot;Total input token savings from prompt caching: {savings_percentage:.2f}% of all input tokens used were read from cache.&quot;)
        print(&quot;Tokens read from cache come at a 90 percent discount!&quot;)

    #æˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨voyage AIè¿›è¡ŒåµŒå…¥ã€‚åœ¨æ­¤å¤„é˜…è¯»æ›´å¤šä¿¡æ¯ï¼šhttps://docs.voyageai.com/docs/embeddings
    def _embed_and_store(self, texts: List[str], data: List[Dict[str, Any]]):
        batch_size = 128
        result = [
            self.voyage_client.embed(
                texts[i : i + batch_size],
                model=&quot;voyage-2&quot;
            ).embeddings
            for i in range(0, len(texts), batch_size)
        ]
        self.embeddings = [embedding for batch in result for embedding in batch]
        self.metadata = data

    def search(self, query: str, k: int = 20) -&gt; List[Dict[str, Any]]:
        if query in self.query_cache:
            query_embedding = self.query_cache[query]
        else:
            query_embedding = self.voyage_client.embed([query], model=&quot;voyage-2&quot;).embeddings[0]
            self.query_cache[query] = query_embedding

        if not self.embeddings:
            raise ValueError(&quot;No data loaded in the vector database.&quot;)

        similarities = np.dot(self.embeddings, query_embedding)
        top_indices = np.argsort(similarities)[::-1][:k]

        top_results = []
        for idx in top_indices:
            result = {
                &quot;metadata&quot;: self.metadata[idx],
                &quot;similarity&quot;: float(similarities[idx]),
            }
            top_results.append(result)
        return top_results

    def save_db(self):
        data = {
            &quot;embeddings&quot;: self.embeddings,
            &quot;metadata&quot;: self.metadata,
            &quot;query_cache&quot;: json.dumps(self.query_cache),
        }
        os.makedirs(os.path.dirname(self.db_path), exist_ok=True)
        with open(self.db_path, &quot;wb&quot;) as file:
            pickle.dump(data, file)

    def load_db(self):
        if not os.path.exists(self.db_path):
            raise ValueError(&quot;Vector database file not found. Use load_data to create a new database.&quot;)
        with open(self.db_path, &quot;rb&quot;) as file:
            data = pickle.load(file)
        self.embeddings = data[&quot;embeddings&quot;]
        self.metadata = data[&quot;metadata&quot;]
        self.query_cache = json.loads(data[&quot;query_cache&quot;])
</code></pre>

<pre class="codehilite"><code class="language-python"># Load the transformed dataset
with open('data/codebase_chunks.json', 'r') as f:
    transformed_dataset = json.load(f)

# Initialize the ContextualVectorDB
contextual_db = ContextualVectorDB(&quot;my_contextual_db&quot;)

# Load and process the data
#æ³¨æ„ï¼šè€ƒè™‘å¢åŠ å¹¶è¡Œçº¿ç¨‹æ•°ä»¥åŠ å¿«è¿è¡Œé€Ÿåº¦ï¼Œæˆ–å‡å°‘å¹¶è¡Œçº¿ç¨‹æ•°ä»¥é¿å…è¾¾åˆ°APIé€Ÿç‡é™åˆ¶
contextual_db.load_data(transformed_dataset, parallel_threads=5)
</code></pre>

<pre class="codehilite"><code>Processing 737 chunks with 5 threads


Processing chunks: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 737/737 [02:37&lt;00:00,  4.69it/s]


Contextual Vector database loaded and saved. Total chunks processed: 737
Total input tokens without caching: 500383
Total output tokens: 40318
Total input tokens written to cache: 341422
Total input tokens read from cache: 2825073
Total input token savings from prompt caching: 77.04% of all input tokens used were read from cache.
Tokens read from cache come at a 90 percent discount!
</code></pre>

<pre class="codehilite"><code class="language-python">r5 = evaluate_db(contextual_db, 'data/evaluation_set.jsonl', 5)
r10 = evaluate_db(contextual_db, 'data/evaluation_set.jsonl', 10)
r20 = evaluate_db(contextual_db, 'data/evaluation_set.jsonl', 20)
</code></pre>

<pre class="codehilite"><code>Evaluating retrieval: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 248/248 [00:06&lt;00:00, 39.53it/s]


Pass@5: 86.37%
Total Score: 0.8637192780337941
Total queries: 248


Evaluating retrieval: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 248/248 [00:06&lt;00:00, 40.05it/s]


Pass@10: 92.81%
Total Score: 0.9280913978494625
Total queries: 248


Evaluating retrieval: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 248/248 [00:06&lt;00:00, 39.64it/s]

Pass@20: 93.78%
Total Score: 0.9378360215053763
Total queries: 248
</code></pre>

<h2 id="_8">æ·»åŠ é‡æ–°æ’åºæ­¥éª¤</h2>
<p>å¦‚æœæ‚¨æƒ³è¿›ä¸€æ­¥æé«˜æ€§èƒ½ï¼Œæˆ‘ä»¬å»ºè®®æ·»åŠ é‡æ–°æ’åºæ­¥éª¤ã€‚åœ¨ä½¿ç”¨é‡æ–°æ’åºå™¨æ—¶ï¼Œæ‚¨å¯ä»¥ä»å‘é‡å­˜å‚¨ä¸­æ£€ç´¢æ›´å¤šæ–‡æ¡£ï¼Œç„¶åä½¿ç”¨é‡æ–°æ’åºå™¨ä»è¿™äº›æ–‡æ¡£ä¸­é€‰æ‹©ä¸€ä¸ªå­é›†ã€‚ä¸€ç§å¸¸è§çš„æŠ€æœ¯æ˜¯å°†é‡æ–°æ’åºä½œä¸ºå®ç°é«˜ç²¾åº¦æ··åˆæœç´¢çš„æ–¹æ³•ã€‚æ‚¨å¯ä»¥åœ¨åˆå§‹æ£€ç´¢æ­¥éª¤ä¸­ä½¿ç”¨è¯­ä¹‰æœç´¢å’ŒåŸºäºå…³é”®å­—çš„æœç´¢çš„ç»„åˆï¼ˆå¦‚æœ¬æŒ‡å—å‰é¢æ‰€è¿°ï¼‰ï¼Œç„¶åä½¿ç”¨é‡æ–°æ’åºæ­¥éª¤ä»è¯­ä¹‰æœç´¢å’Œå…³é”®å­—æœç´¢ç³»ç»Ÿè¿”å›çš„æ–‡æ¡£ç»„åˆåˆ—è¡¨ä¸­ä»…é€‰æ‹©kä¸ªæœ€ç›¸å…³çš„æ–‡æ¡£ã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°†ä»…æ¼”ç¤ºé‡æ–°æ’åºæ­¥éª¤ï¼ˆæš‚æ—¶è·³è¿‡æ··åˆæœç´¢æŠ€æœ¯ï¼‰ã€‚æ‚¨ä¼šçœ‹åˆ°ï¼Œæˆ‘ä»¬æ£€ç´¢çš„æ–‡æ¡£æ•°é‡æ˜¯æˆ‘ä»¬å¸Œæœ›æ£€ç´¢çš„æœ€ç»ˆkä¸ªæ–‡æ¡£æ•°é‡çš„10å€ï¼Œç„¶åä½¿ç”¨Cohereçš„é‡æ–°æ’åºæ¨¡å‹ä»è¯¥åˆ—è¡¨ä¸­é€‰æ‹©10ä¸ªæœ€ç›¸å…³çš„ç»“æœã€‚æ·»åŠ é‡æ–°æ’åºæ­¥éª¤å¯å¸¦æ¥é€‚åº¦çš„é¢å¤–æ€§èƒ½æå‡ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼ŒPass@10ä»92.81%æé«˜åˆ°94.79%ã€‚</p>
<pre class="codehilite"><code class="language-python">import cohere
from typing import List, Dict, Any, Callable
import json
from tqdm import tqdm

def load_jsonl(file_path: str) -&gt; List[Dict[str, Any]]:
    with open(file_path, 'r') as file:
        return [json.loads(line) for line in file]

def chunk_to_content(chunk: Dict[str, Any]) -&gt; str:
    original_content = chunk['metadata']['original_content']
    contextualized_content = chunk['metadata']['contextualized_content']
    return f&quot;{original_content}\n\nContext: {contextualized_content}&quot; 

def retrieve_rerank(query: str, db, k: int) -&gt; List[Dict[str, Any]]:
    co = cohere.Client( os.getenv(&quot;COHERE_API_KEY&quot;))

    #æ£€ç´¢æ¯”æˆ‘ä»¬é€šå¸¸æ£€ç´¢çš„æ›´å¤šçš„ç»“æœ
    semantic_results = db.search(query, k=k*10)

    #æå–ç”¨äºé‡æ–°æ’åºçš„æ–‡æ¡£ï¼Œä½¿ç”¨ä¸Šä¸‹æ–‡åŒ–çš„å†…å®¹
    documents = [chunk_to_content(res) for res in semantic_results]

    response = co.rerank(
        model=&quot;rerank-english-v3.0&quot;,
        query=query,
        documents=documents,
        top_n=k
    )
    time.sleep(0.1)

    final_results = []
    for r in response.results:
        original_result = semantic_results[r.index]
        final_results.append({
            &quot;chunk&quot;: original_result['metadata'],
            &quot;score&quot;: r.relevance_score
        })

    return final_results

def evaluate_retrieval_rerank(queries: List[Dict[str, Any]], retrieval_function: Callable, db, k: int = 20) -&gt; Dict[str, float]:
    total_score = 0
    total_queries = len(queries)

    for query_item in tqdm(queries, desc=&quot;Evaluating retrieval&quot;):
        query = query_item['query']
        golden_chunk_uuids = query_item['golden_chunk_uuids']

        golden_contents = []
        for doc_uuid, chunk_index in golden_chunk_uuids:
            golden_doc = next((doc for doc in query_item['golden_documents'] if doc['uuid'] == doc_uuid), None)
            if golden_doc:
                golden_chunk = next((chunk for chunk in golden_doc['chunks'] if chunk['index'] == chunk_index), None)
                if golden_chunk:
                    golden_contents.append(golden_chunk['content'].strip())

        if not golden_contents:
            print(f&quot;è­¦å‘Šï¼šæœªæ‰¾åˆ°æŸ¥è¯¢çš„é»„é‡‘å†…å®¹ï¼š{query}&quot;)
            continue

        retrieved_docs = retrieval_function(query, db, k)

        chunks_found = 0
        for golden_content in golden_contents:
            for doc in retrieved_docs[:k]:
                retrieved_content = doc['chunk']['original_content'].strip()
                if retrieved_content == golden_content:
                    chunks_found += 1
                    break

        query_score = chunks_found / len(golden_contents)
        total_score += query_score

    average_score = total_score / total_queries
    pass_at_n = average_score * 100
    return {
        &quot;pass_at_n&quot;: pass_at_n,
        &quot;average_score&quot;: average_score,
        &quot;total_queries&quot;: total_queries
    }

def evaluate_db_advanced(db, original_jsonl_path, k):
    original_data = load_jsonl(original_jsonl_path)

    def retrieval_function(query, db, k):
        return retrieve_rerank(query, db, k)

    results = evaluate_retrieval_rerank(original_data, retrieval_function, db, k)
    print(f&quot;Pass@{k}: {results['pass_at_n']:.2f}%&quot;)
    print(f&quot;Average Score: {results['average_score']}&quot;)
    print(f&quot;Total queries: {results['total_queries']}&quot;)
    return results
</code></pre>

<pre class="codehilite"><code class="language-python">results5 = evaluate_db_advanced(contextual_db, 'data/evaluation_set.jsonl', 5)
results10 = evaluate_db_advanced(contextual_db, 'data/evaluation_set.jsonl', 10)
results20 = evaluate_db_advanced(contextual_db, 'data/evaluation_set.jsonl', 20)
</code></pre>

<pre class="codehilite"><code>Evaluating retrieval: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 248/248 [01:22&lt;00:00,  2.99it/s]


Pass@5: 91.24%
Average Score: 0.912442396313364
Total queries: 248


Evaluating retrieval: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 248/248 [01:34&lt;00:00,  2.63it/s]


Pass@10: 94.79%
Average Score: 0.9479166666666667
Total queries: 248


Evaluating retrieval: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 248/248 [02:08&lt;00:00,  1.93it/s]

Pass@20: 96.30%
Average Score: 0.9630376344086022
Total queries: 248
</code></pre>

<h3 id="_9">åç»­æ­¥éª¤å’Œå…³é”®è¦ç‚¹</h3>
<p>1) æˆ‘ä»¬æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ä¸Šä¸‹æ–‡åµŒå…¥æ¥æé«˜æ£€ç´¢æ€§èƒ½ï¼Œç„¶åé€šè¿‡ä¸Šä¸‹æ–‡BM25å’Œé‡æ–°æ’åºè¿›è¡Œäº†è¿›ä¸€æ­¥æ”¹è¿›ã€‚</p>
<p>2) æ­¤ç¤ºä¾‹ä½¿ç”¨äº†ä»£ç åº“ï¼Œä½†è¿™äº›æ–¹æ³•ä¹Ÿé€‚ç”¨äºå…¶ä»–æ•°æ®ç±»å‹ï¼Œå¦‚å†…éƒ¨å…¬å¸çŸ¥è¯†åº“ã€è´¢åŠ¡ä¸æ³•å¾‹å†…å®¹ã€æ•™è‚²å†…å®¹ç­‰ã€‚ </p>
<p>3) å¦‚æœæ‚¨æ˜¯AWSç”¨æˆ·ï¼Œå¯ä»¥ä»<code>contextual-rag-lambda-function</code>ä¸­çš„Lambdaå‡½æ•°å¼€å§‹ï¼Œå¦‚æœæ‚¨æ˜¯GCPç”¨æˆ·ï¼Œå¯ä»¥å¯åŠ¨è‡ªå·±çš„Cloud Runå®ä¾‹å¹¶éµå¾ªç±»ä¼¼çš„æ¨¡å¼ï¼</p>
            </article>
            
            <nav class="page-nav"><a href="skills/text_to_sql/guide_zh.html" class="nav-link prev">â† Set your Anthropic API key</a><a href="third_party/VoyageAI/how_to_create_embeddings_zh.html" class="nav-link next">è¿™å°†è‡ªåŠ¨ä½¿ç”¨ç¯å¢ƒå˜é‡VOYAGE_API_KEYã€‚ â†’</a></nav>
        </main>
    </div>
</body>
</html>