<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="../../">
    <title>增强检索的RAG与上下文检索</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>目录</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="搜索..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-folder " data-level="0" >
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">extended_thinking</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="extended_thinking/extended_thinking_with_tool_use_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">扩展思考与工具使用</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="extended_thinking/extended_thinking_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">扩展思考</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="0" >
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">finetuning</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="finetuning/finetuning_on_bedrock_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">在 Bedrock 上微调 Claude 3 Haiku</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="0" >
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">misc</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/batch_processing_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">批量处理消息批次API</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/building_evals_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">建立评估</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/building_moderation_filter_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">建立一个带有 Claude 的审核过滤器</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/generate_test_cases_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">首先，我们有 `extract_variables` 函数，</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/how_to_enable_json_mode_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">提示 Claude 获取“JSON 模式”</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/how_to_make_sql_queries_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">如何使用 Claude 进行 SQL 查询</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/illustrated_responses_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Claude 的图示化响应</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/mc_qa_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">实验性测试 Claude 的长上下文问答能力</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/metaprompt_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Metaprompt</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/pdf_upload_summarization_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">“上传”PDF 到 Claude API</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/prompt_caching_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">缓存提示（Prompt caching）通过 Anthropic API</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/read_web_pages_with_haiku_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">使用 Claude 3 Haiku 总结网页内容</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/sampling_past_max_tokens_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Claude 从 Claude 之外的采样响应，超出最大令牌限制</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/speculative_prompt_caching_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">投机性提示缓存</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="misc/using_citations_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">引言</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="0" >
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">multimodal</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="multimodal/best_practices_for_vision_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="multimodal/getting_started_with_vision_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">开始上手 - 如何将图像传递给 Claude</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="multimodal/how_to_transcribe_text_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">如何使用 Claude 转录文档</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="multimodal/reading_charts_graphs_powerpoints_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">使用图表和幻灯片放映</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="multimodal/using_sub_agents_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">使用 Haiku 作为子代理</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="0" >
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">patterns</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">agents</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="patterns/agents/basic_workflows_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">首先使用具有思维链的LLM确定适当的路由</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="patterns/agents/evaluator_optimizer_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="patterns/agents/orchestrator_workers_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">步骤1：获取协调器响应</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="patterns/agents/README_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">构建高效代理的食谱</span>
                        </a>
                    </div>
                
                    <div class="tree-folder " data-level="2" style="padding-left: 40px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">prompts</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 60px;">
                        <a href="patterns/agents/prompts/citations_agent_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 60px;">
                        <a href="patterns/agents/prompts/research_lead_agent_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 60px;">
                        <a href="patterns/agents/prompts/research_subagent_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </div></div></div></div></div></div>
                    <div class="tree-folder expanded" data-level="0" >
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">skills</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="skills/README_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Claude 技能</span>
                        </a>
                    </div>
                
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">classification</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="skills/classification/guide_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">设置我们的环境</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="skills/classification/README_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Claude 分类指南</span>
                        </a>
                    </div>
                
                    <div class="tree-folder " data-level="2" style="padding-left: 40px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">evaluation</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 60px;">
                        <a href="skills/classification/evaluation/README_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">使用 Promptfoo 进行评估</span>
                        </a>
                    </div>
                </div></div></div></div>
                    <div class="tree-folder expanded" data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">contextual-embeddings</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item active" style="padding-left: 40px;">
                        <a href="skills/contextual-embeddings/guide_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">增强检索的RAG与上下文检索</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="skills/contextual-embeddings/README_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">结合上下文嵌入的检索增强生成</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">retrieval_augmented_generation</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="skills/retrieval_augmented_generation/guide_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Retrieval Augmented Generation (RAG)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="skills/retrieval_augmented_generation/README_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                
                    <div class="tree-folder " data-level="2" style="padding-left: 40px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">evaluation</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 60px;">
                        <a href="skills/retrieval_augmented_generation/evaluation/README_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">使用 Promptfoo 进行评估</span>
                        </a>
                    </div>
                </div></div></div></div>
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">summarization</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="skills/summarization/guide_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">摘要与 Claude</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="skills/summarization/README_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Claude 摘要</span>
                        </a>
                    </div>
                
                    <div class="tree-folder " data-level="2" style="padding-left: 40px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">evaluation</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 60px;">
                        <a href="skills/summarization/evaluation/README_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Promptfoo 评估</span>
                        </a>
                    </div>
                </div></div></div></div>
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">text_to_sql</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="skills/text_to_sql/guide_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Set your Anthropic API key</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="skills/text_to_sql/README_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Claude 的文本到 SQL</span>
                        </a>
                    </div>
                
                    <div class="tree-folder " data-level="2" style="padding-left: 40px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">evaluation</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 60px;">
                        <a href="skills/text_to_sql/evaluation/README_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Promptfoo 评估</span>
                        </a>
                    </div>
                </div></div></div></div></div></div>
                    <div class="tree-folder " data-level="0" >
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">third_party</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">Deepgram</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/Deepgram/prerecorded_audio_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">转录深蓝音频文件并使用 Anthropic 准备面试问题！</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/Deepgram/README_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Deepgram <> Anthropic Cookbooks</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">LlamaIndex</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/LlamaIndex/Basic_RAG_With_LlamaIndex_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">RAG 管道与 LlamaIndex</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/LlamaIndex/Multi_Document_Agents_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">多文档代理</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/LlamaIndex/Multi_Modal_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">多模态</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/LlamaIndex/ReAct_Agent_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">ReAct Agent</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/LlamaIndex/README_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">LlamaIndex <> Anthropic Cookbooks</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/LlamaIndex/Router_Query_Engine_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">注意：这仅在 jupyter notebook 中是必需的。</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/LlamaIndex/SubQuestion_Query_Engine_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">SubQuestionQueryEngine</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">MongoDB</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/MongoDB/rag_using_mongodb_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">如何使用 Claude 3 和 MongoDB 构建 RAG 系统</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">Pinecone</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/Pinecone/claude_3_rag_agent_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">检查 Python 版本</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/Pinecone/rag_using_pinecone_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">使用 Pinecone 进行检索增强生成</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">VoyageAI</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/VoyageAI/how_to_create_embeddings_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">这将自动使用环境变量VOYAGE_API_KEY。</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">Wikipedia</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/Wikipedia/wikipedia-search-cookbook_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">迭代搜索维基百科与 Claude</span>
                        </a>
                    </div>
                </div></div>
                    <div class="tree-folder " data-level="1" style="padding-left: 20px;">
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">WolframAlpha</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 40px;">
                        <a href="third_party/WolframAlpha/using_llm_api_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">使用 Wolfram Alpha LLM API 作为 Claude 的工具</span>
                        </a>
                    </div>
                </div></div></div></div>
                    <div class="tree-folder " data-level="0" >
                        <div class="tree-folder-header">
                            <span class="tree-arrow">▶</span>
                            <span class="tree-icon"></span>
                            <span class="tree-title">tool_use</span>
                        </div>
                        <div class="tree-folder-content">
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="tool_use/calculator_tool_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">使用计算器工具与 Claude</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="tool_use/customer_service_agent_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">使用客户端工具创建客服代理</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="tool_use/extracting_structured_json_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">使用 Claude 和工具使用功能提取结构化 JSON</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="tool_use/memory_cookbook_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">安装依赖</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="tool_use/parallel_tools_claude_3_7_sonnet_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">在 Claude 3.7 Sonnet 上并行调用工具</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="tool_use/tool_choice_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">选择工具</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="tool_use/tool_use_with_pydantic_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">记事工具，支持 Pydantic 和 Anthropic 工具使用</span>
                        </a>
                    </div>
                
                    <div class="tree-item " style="padding-left: 20px;">
                        <a href="tool_use/vision_with_tools_zh.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">使用 Vision 与工具</span>
                        </a>
                    </div>
                </div></div></nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="rag">增强检索的RAG与上下文检索</h1>
<blockquote>
<p>注意：有关上下文检索的更多背景信息，包括在各种数据集上的其他性能评估，我们建议阅读我们配套的<a href="https://www.anthropic.com/news/contextual-retrieval">博客文章</a>。</p>
</blockquote>
<p>检索增强生成（RAG）使Claude能够在提供响应时利用您的内部知识库、代码库或任何其他文档语料库。企业越来越多地构建RAG应用程序来改进客户支持、问答内部公司文档、财务与法律分析、代码生成等工作流程。</p>
<p>在<a href="https://github.com/anthropics/anthropic-cookbook/blob/main/skills/retrieval_augmented_generation/guide.ipynb">单独的指南</a>中，我们介绍了设置基本检索系统，演示了如何评估其性能，然后概述了几种提高性能的技术。在本指南中，我们将介绍一种提高检索性能的技术：上下文嵌入。</p>
<p>在传统的RAG中，文档通常被分割成更小的块以实现高效检索。虽然这种方法对许多应用程序都有效，但当单个块缺乏足够上下文时，可能会导致问题。上下文嵌入通过在嵌入每个块之前添加相关上下文来解决此问题。这种方法提高了每个嵌入块的质量，从而实现了更准确的检索，进而提高了整体性能。在我们测试的所有数据源的平均值来看，上下文嵌入将前20个块的检索失败率降低了35%。</p>
<p>同样的块特定上下文也可以与BM25搜索一起使用，以进一步提高检索性能。我们在“上下文BM25”部分介绍了这项技术。</p>
<p>在本指南中，我们将演示如何使用9个代码库的数据集作为我们的知识库来构建和优化上下文检索系统。我们将介绍：</p>
<p>1) 设置基本检索管道以建立性能基线。</p>
<p>2) 上下文嵌入：它是什么，为什么有效，以及提示缓存如何使其在生产用例中可行。</p>
<p>3) 实现上下文嵌入并演示性能改进。</p>
<p>4) 上下文BM25：通过<em>上下文</em>BM25混合搜索提高性能。</p>
<p>5) 通过重新排序提高性能，</p>
<h3 id="_1">评估指标与数据集：</h3>
<p>我们使用预分块的9个代码库数据集——所有这些代码库都已根据基本的字符分割机制进行了分块。我们的评估数据集包含248个查询——每个查询都包含一个“黄金块”。我们将使用一种称为Pass@k的指标来评估性能。Pass@k检查在为每个查询检索到的前k个文档中是否存在“黄金文档”。在这种情况下，上下文嵌入帮助我们将Pass@10性能从约87%提高到约95%。</p>
<p>您可以在<code>data/codebase_chunks.json</code>中找到代码文件及其块，在<code>data/evaluation_set.jsonl</code>中找到评估数据集。</p>
<h4 id="_2">附加说明：</h4>
<p>提示缓存有助于管理此检索方法的成本。此功能目前在Anthropic的1P API上可用，并即将登陆AWS Bedrock和GCP Vertex中的3P合作伙伴环境。我们知道许多客户在构建RAG解决方案时会利用AWS知识库和GCP Vertex AI API，并且此方法可以在任一平台上使用，只需稍作定制。考虑联系Anthropic或您的AWS/GCP客户团队以获取指导！</p>
<p>为了方便在Bedrock上使用此方法，AWS团队为我们提供了代码，您可以使用它来实现一个Lambda函数，该函数为每个文档添加上下文。如果您部署此Lambda函数，可以在配置<a href="https://docs.aws.amazon.com/bedrock/latest/userguide/knowledge-base-create.html">Bedrock知识库</a>时选择它作为自定义分块选项。您可以在<code>contextual-rag-lambda-function</code>中找到此代码。主要的Lambda函数代码在<code>lambda_function.py</code>中。</p>
<h2 id="_3">目录</h2>
<p>1) 设置</p>
<p>2) 基本RAG</p>
<p>3) 上下文嵌入</p>
<p>4) 上下文BM25</p>
<p>5) 重新排序</p>
<h2 id="_4">设置</h2>
<p>我们需要一些库，包括：</p>
<p>1) <code>anthropic</code> - 用于与Claude交互</p>
<p>2) <code>voyageai</code> - 用于生成高质量嵌入</p>
<p>3) <code>cohere</code> - 用于重新排序</p>
<p>4) <code>elasticsearch</code> 用于高性能BM25搜索</p>
<p>3) <code>pandas</code>、<code>numpy</code>、<code>matplotlib</code>和<code>scikit-learn</code>用于数据操作和可视化</p>
<p>您还需要来自<a href="https://www.anthropic.com/">Anthropic</a>、<a href="https://www.voyageai.com/">Voyage AI</a>和<a href="https://cohere.com/rerank">Cohere</a>的API密钥</p>
<pre class="codehilite"><code class="language-python">!pip install anthropic
!pip install voyageai
!pip install cohere
!pip install elasticsearch
!pip install pandas
!pip install numpy
</code></pre>

<pre class="codehilite"><code class="language-python">import os

os.environ['VOYAGE_API_KEY'] = &quot;YOUR KEY HERE&quot;
os.environ['ANTHROPIC_API_KEY'] = &quot;YOUR KEY HERE&quot;
os.environ['COHERE_API_KEY'] = &quot;YOUR KEY HERE&quot;
</code></pre>

<pre class="codehilite"><code class="language-python">import anthropic

client = anthropic.Anthropic(
    # This is the default and can be omitted
    api_key=os.getenv(&quot;ANTHROPIC_API_KEY&quot;),
)
</code></pre>

<h3 id="_5">初始化向量数据库类</h3>
<p>在此示例中，我们使用的是内存中的向量数据库，但对于生产应用程序，您可能希望使用托管解决方案。 </p>
<pre class="codehilite"><code class="language-python">import os
import pickle
import json
import numpy as np
import voyageai
from typing import List, Dict, Any
from tqdm import tqdm

class VectorDB:
    def __init__(self, name: str, api_key = None):
        if api_key is None:
            api_key = os.getenv(&quot;VOYAGE_API_KEY&quot;)
        self.client = voyageai.Client(api_key=api_key)
        self.name = name
        self.embeddings = []
        self.metadata = []
        self.query_cache = {}
        self.db_path = f&quot;./data/{name}/vector_db.pkl&quot;

    def load_data(self, dataset: List[Dict[str, Any]]):
        if self.embeddings and self.metadata:
            print(&quot;Vector database is already loaded. Skipping data loading.&quot;)
            return
        if os.path.exists(self.db_path):
            print(&quot;Loading vector database from disk.&quot;)
            self.load_db()
            return

        texts_to_embed = []
        metadata = []
        total_chunks = sum(len(doc['chunks']) for doc in dataset)

        with tqdm(total=total_chunks, desc=&quot;Processing chunks&quot;) as pbar:
            for doc in dataset:
                for chunk in doc['chunks']:
                    texts_to_embed.append(chunk['content'])
                    metadata.append({
                        'doc_id': doc['doc_id'],
                        'original_uuid': doc['original_uuid'],
                        'chunk_id': chunk['chunk_id'],
                        'original_index': chunk['original_index'],
                        'content': chunk['content']
                    })
                    pbar.update(1)

        self._embed_and_store(texts_to_embed, metadata)
        self.save_db()

        print(f&quot;Vector database loaded and saved. Total chunks processed: {len(texts_to_embed)}&quot;)

    def _embed_and_store(self, texts: List[str], data: List[Dict[str, Any]]):
        batch_size = 128
        with tqdm(total=len(texts), desc=&quot;Embedding chunks&quot;) as pbar:
            result = []
            for i in range(0, len(texts), batch_size):
                batch = texts[i : i + batch_size]
                batch_result = self.client.embed(batch, model=&quot;voyage-2&quot;).embeddings
                result.extend(batch_result)
                pbar.update(len(batch))

        self.embeddings = result
        self.metadata = data

    def search(self, query: str, k: int = 20) -&gt; List[Dict[str, Any]]:
        if query in self.query_cache:
            query_embedding = self.query_cache[query]
        else:
            query_embedding = self.client.embed([query], model=&quot;voyage-2&quot;).embeddings[0]
            self.query_cache[query] = query_embedding

        if not self.embeddings:
            raise ValueError(&quot;No data loaded in the vector database.&quot;)

        similarities = np.dot(self.embeddings, query_embedding)
        top_indices = np.argsort(similarities)[::-1][:k]

        top_results = []
        for idx in top_indices:
            result = {
                &quot;metadata&quot;: self.metadata[idx],
                &quot;similarity&quot;: float(similarities[idx]),
            }
            top_results.append(result)

        return top_results

    def save_db(self):
        data = {
            &quot;embeddings&quot;: self.embeddings,
            &quot;metadata&quot;: self.metadata,
            &quot;query_cache&quot;: json.dumps(self.query_cache),
        }
        os.makedirs(os.path.dirname(self.db_path), exist_ok=True)
        with open(self.db_path, &quot;wb&quot;) as file:
            pickle.dump(data, file)

    def load_db(self):
        if not os.path.exists(self.db_path):
            raise ValueError(&quot;Vector database file not found. Use load_data to create a new database.&quot;)
        with open(self.db_path, &quot;rb&quot;) as file:
            data = pickle.load(file)
        self.embeddings = data[&quot;embeddings&quot;]
        self.metadata = data[&quot;metadata&quot;]
        self.query_cache = json.loads(data[&quot;query_cache&quot;])

    def validate_embedded_chunks(self):
        unique_contents = set()
        for meta in self.metadata:
            unique_contents.add(meta['content'])

        print(f&quot;Validation results:&quot;)
        print(f&quot;Total embedded chunks: {len(self.metadata)}&quot;)
        print(f&quot;Unique embedded contents: {len(unique_contents)}&quot;)

        if len(self.metadata) != len(unique_contents):
            print(&quot;Warning: There may be duplicate chunks in the embedded data.&quot;)
        else:
            print(&quot;All embedded chunks are unique.&quot;)
</code></pre>

<pre class="codehilite"><code class="language-python"># Load your transformed dataset
with open('data/codebase_chunks.json', 'r') as f:
    transformed_dataset = json.load(f)

# Initialize the VectorDB
base_db = VectorDB(&quot;base_db&quot;)

# Load and process the data
base_db.load_data(transformed_dataset)
</code></pre>

<h2 id="rag_1">基本RAG</h2>
<p>为了开始，我们将使用一种最基本的方法来设置一个基本的RAG管道。这有时被称为行业中的“朴素RAG”。一个基本的RAG管道包括以下3个步骤：</p>
<p>1) 按标题分块文档 - 只包含每个子标题的内容</p>
<p>2) 嵌入每个文档</p>
<p>3) 使用余弦相似度检索文档以回答查询</p>
<pre class="codehilite"><code class="language-python">import json
from typing import List, Dict, Any, Callable, Union
from tqdm import tqdm

def load_jsonl(file_path: str) -&gt; List[Dict[str, Any]]:
    &quot;&quot;&quot;加载JSONL文件并返回字典列表。&quot;&quot;&quot;
    with open(file_path, 'r') as file:
        return [json.loads(line) for line in file]

def evaluate_retrieval(queries: List[Dict[str, Any]], retrieval_function: Callable, db, k: int = 20) -&gt; Dict[str, float]:
    total_score = 0
    total_queries = len(queries)

    for query_item in tqdm(queries, desc=&quot;Evaluating retrieval&quot;):
        query = query_item['query']
        golden_chunk_uuids = query_item['golden_chunk_uuids']

        # 查找所有黄金块内容
        golden_contents = []
        for doc_uuid, chunk_index in golden_chunk_uuids:
            golden_doc = next((doc for doc in query_item['golden_documents'] if doc['uuid'] == doc_uuid), None)
            if not golden_doc:
                print(f&quot;警告：找不到UUID {doc_uuid} 的黄金文档&quot;)
                continue

            golden_chunk = next((chunk for chunk in golden_doc['chunks'] if chunk['index'] == chunk_index), None)
            if not golden_chunk:
                print(f&quot;警告：在文档 {doc_uuid} 中找不到索引 {chunk_index} 的黄金块&quot;)
                continue

            golden_contents.append(golden_chunk['content'].strip())

        if not golden_contents:
            print(f&quot;警告：未找到查询的黄金内容：{query}&quot;)
            continue

        retrieved_docs = retrieval_function(query, db, k=k)

        # 计算检索到的前k个文档中有多少个黄金块
        chunks_found = 0
        for golden_content in golden_contents:
            for doc in retrieved_docs[:k]:
                retrieved_content = doc['metadata'].get('original_content', doc['metadata'].get('content', '')).strip()
                if retrieved_content == golden_content:
                    chunks_found += 1
                    break

        query_score = chunks_found / len(golden_contents)
        total_score += query_score

    average_score = total_score / total_queries
    pass_at_n = average_score * 100
    return {
        &quot;pass_at_n&quot;: pass_at_n,
        &quot;average_score&quot;: average_score,
        &quot;total_queries&quot;: total_queries
    }

def retrieve_base(query: str, db, k: int = 20) -&gt; List[Dict[str, Any]]:
    &quot;&quot;&quot;
    使用VectorDB或ContextualVectorDB检索相关文档。

    :param query: 查询字符串
    :param db: VectorDB或ContextualVectorDB实例
    :param k: 要检索的前k个结果的数量
    :return: 检索到的文档列表
    &quot;&quot;&quot;
    return db.search(query, k=k)

def evaluate_db(db, original_jsonl_path: str, k):
    # 加载原始JSONL数据用于查询和地面真实
    original_data = load_jsonl(original_jsonl_path)

    # 评估检索
    results = evaluate_retrieval(original_data, retrieve_base, db, k)
    print(f&quot;Pass@{k}: {results['pass_at_n']:.2f}%&quot;)
    print(f&quot;Total Score: {results['average_score']}&quot;)
    print(f&quot;Total queries: {results['total_queries']}&quot;)
</code></pre>

<pre class="codehilite"><code class="language-python">results5 = evaluate_db(base_db, 'data/evaluation_set.jsonl', 5)
results10 = evaluate_db(base_db, 'data/evaluation_set.jsonl', 10)
results20 = evaluate_db(base_db, 'data/evaluation_set.jsonl', 20)
</code></pre>

<pre class="codehilite"><code>Evaluating retrieval: 100%|██████████| 248/248 [00:06&lt;00:00, 40.70it/s]


Pass@5: 80.92%
Total Score: 0.8091877880184332
Total queries: 248


Evaluating retrieval: 100%|██████████| 248/248 [00:06&lt;00:00, 39.50it/s]


Pass@10: 87.15%
Total Score: 0.8714957757296468
Total queries: 248


Evaluating retrieval: 100%|██████████| 248/248 [00:06&lt;00:00, 39.43it/s]

Pass@20: 90.06%
Total Score: 0.9006336405529954
Total queries: 248
</code></pre>

<h2 id="_6">上下文嵌入</h2>
<p>通过基本RAG，每个嵌入的块都包含可能有用信息，但这些块缺乏上下文。通过上下文嵌入，我们通过在嵌入每个文本块之前添加更多上下文来创建嵌入本身的变体。具体来说，我们使用Claude为每个块创建一个简洁的上下文，解释该块，并利用整个文档的上下文。在我们的代码库数据集的情况下，我们可以将块和每个块所在的整个文件提供给LLM，然后生成上下文。然后，我们将此“上下文”和原始文本块组合成一个单一的文本块，然后再创建每个嵌入。</p>
<h3 id="_7">其他考虑因素：成本和延迟</h3>
<p>我们为“定位”每个文档所做的额外工作仅在摄取时发生：这是您存储每个文档时（以及将来如果您的知识库更新时）需要支付一次的成本。有许多方法，如HyDE（假设文档嵌入），涉及在执行搜索之前执行步骤来改进查询的表示。这些技术已被证明具有中等效果，但它们会显著增加运行时的延迟。</p>
<p><a href="https://docs.anthropic.com/en/docs/build-with-claude/prompt-caching">提示缓存</a>也使其更具成本效益。创建上下文嵌入需要我们将相同的文档传递给模型，以获取我们想要生成额外上下文的每个块。通过提示缓存，我们可以将整个文档写入缓存一次，然后因为我们按顺序执行所有摄取工作，所以可以在生成该文档内每个块的上下文时从缓存中读取文档（您写入缓存的信息有5分钟的生存时间）。这意味着我们第一次将文档传递给模型时，我们会支付稍多一点的费用将其写入缓存，但对于包含该文档的每个后续API调用，我们将获得90%的缓存读取输入令牌折扣。假设800个令牌块，8k个令牌文档，50个令牌上下文指令，以及每个块100个令牌的上下文，则生成上下文化块的成本为每百万个文档令牌1.02美元。</p>
<p>当您在下面将数据加载到ContextualVectorDB时，您将在日志中看到这种影响有多大。 </p>
<p>警告：一些较小的嵌入模型具有固定的输入令牌限制。上下文化块会使其变长，因此如果您注意到上下文化嵌入的性能明显变差，则上下文化块很可能被截断了</p>
<pre class="codehilite"><code class="language-python">DOCUMENT_CONTEXT_PROMPT = &quot;&quot;&quot;
&lt;document&gt;
{doc_content}
&lt;/document&gt;
&quot;&quot;&quot;

CHUNK_CONTEXT_PROMPT = &quot;&quot;&quot;
这是我们想要在整个文档中定位的块
&lt;chunk&gt;
{chunk_content}
&lt;/chunk&gt;

请提供一个简短的上下文来将此块定位在整个文档中，以改进块的搜索检索。
只回答简洁的上下文，不要回答其他任何内容。
&quot;&quot;&quot;

def situate_context(doc: str, chunk: str) -&gt; str:
    response = client.beta.prompt_caching.messages.create(
        model=&quot;claude-3-haiku-20240307&quot;,
        max_tokens=1024,
        temperature=0.0,
        messages=[
            {
                &quot;role&quot;: &quot;user&quot;, 
                &quot;content&quot;: [
                    {
                        &quot;type&quot;: &quot;text&quot;,
                        &quot;text&quot;: DOCUMENT_CONTEXT_PROMPT.format(doc_content=doc),
                        &quot;cache_control&quot;: {&quot;type&quot;: &quot;ephemeral&quot;} #我们将为整个文档利用提示缓存
                    },
                    {
                        &quot;type&quot;: &quot;text&quot;,
                        &quot;text&quot;: CHUNK_CONTEXT_PROMPT.format(chunk_content=chunk),
                    }
                ]
            }
        ],
        extra_headers={&quot;anthropic-beta&quot;: &quot;prompt-caching-2024-07-31&quot;}
    )
    return response

# 示例用法
doc_content = jsonl_data[0]['golden_documents'][0]['content']
chunk_content = jsonl_data[0]['golden_chunks'][0]['content']

response = situate_context(doc_content, chunk_content)
print(f&quot;Situated context: {response.content[0].text}&quot;)

# 打印缓存性能指标
print(f&quot;Input tokens: {response.usage.input_tokens}&quot;)
print(f&quot;Output tokens: {response.usage.output_tokens}&quot;)
print(f&quot;Cache creation input tokens: {response.usage.cache_creation_input_tokens}&quot;)
print(f&quot;Cache read input tokens: {response.usage.cache_read_input_tokens}&quot;)
</code></pre>

<pre class="codehilite"><code>Situated context: This chunk describes the `DiffExecutor` struct, which is an executor for differential fuzzing. It wraps two executors that are run sequentially with the same input, and also runs the secondary executor in the `run_target` method.
Input tokens: 366
Output tokens: 55
Cache creation input tokens: 3046
Cache read input tokens: 0
</code></pre>

<pre class="codehilite"><code class="language-python">import os
import pickle
import json
import numpy as np
import voyageai
from typing import List, Dict, Any
from tqdm import tqdm
import anthropic
import threading
import time
from concurrent.futures import ThreadPoolExecutor, as_completed

class ContextualVectorDB:
    def __init__(self, name: str, voyage_api_key=None, anthropic_api_key=None):
        if voyage_api_key is None:
            voyage_api_key = os.getenv(&quot;VOYAGE_API_KEY&quot;)
        if anthropic_api_key is None:
            anthropic_api_key = os.getenv(&quot;ANTHROPIC_API_KEY&quot;)

        self.voyage_client = voyageai.Client(api_key=voyage_api_key)
        self.anthropic_client = anthropic.Anthropic(api_key=anthropic_api_key)
        self.name = name
        self.embeddings = []
        self.metadata = []
        self.query_cache = {}
        self.db_path = f&quot;./data/{name}/contextual_vector_db.pkl&quot;

        self.token_counts = {
            'input': 0,
            'output': 0,
            'cache_read': 0,
            'cache_creation': 0
        }
        self.token_lock = threading.Lock()

    def situate_context(self, doc: str, chunk: str) -&gt; tuple[str, Any]:
        DOCUMENT_CONTEXT_PROMPT = &quot;&quot;&quot;
        &lt;document&gt;
        {doc_content}
        &lt;/document&gt;
        &quot;&quot;&quot;

        CHUNK_CONTEXT_PROMPT = &quot;&quot;&quot;
        这是我们想要在整个文档中定位的块
        &lt;chunk&gt;
        {chunk_content}
        &lt;/chunk&gt;

        请提供一个简短的上下文来将此块定位在整个文档中，以改进块的搜索检索。
        只回答简洁的上下文，不要回答其他任何内容。
        &quot;&quot;&quot;

        response = self.anthropic_client.beta.prompt_caching.messages.create(
            model=&quot;claude-3-haiku-20240307&quot;,
            max_tokens=1000,
            temperature=0.0,
            messages=[
                {
                    &quot;role&quot;: &quot;user&quot;, 
                    &quot;content&quot;: [
                        {
                            &quot;type&quot;: &quot;text&quot;,
                            &quot;text&quot;: DOCUMENT_CONTEXT_PROMPT.format(doc_content=doc),
                            &quot;cache_control&quot;: {&quot;type&quot;: &quot;ephemeral&quot;} #我们将在整个文档中使用提示缓存
                        },
                        {
                            &quot;type&quot;: &quot;text&quot;,
                            &quot;text&quot;: CHUNK_CONTEXT_PROMPT.format(chunk_content=chunk),
                        },
                    ]
                },
            ],
            extra_headers={&quot;anthropic-beta&quot;: &quot;prompt-caching-2024-07-31&quot;}
        )
        return response.content[0].text, response.usage

    def load_data(self, dataset: List[Dict[str, Any]], parallel_threads: int = 1):
        if self.embeddings and self.metadata:
            print(&quot;Vector database is already loaded. Skipping data loading.&quot;)
            return
        if os.path.exists(self.db_path):
            print(&quot;Loading vector database from disk.&quot;)
            self.load_db()
            return

        texts_to_embed = []
        metadata = []
        total_chunks = sum(len(doc['chunks']) for doc in dataset)

        def process_chunk(doc, chunk):
            #对于每个块，生成上下文
            contextualized_text, usage = self.situate_context(doc['content'], chunk['content'])
            with self.token_lock:
                self.token_counts['input'] += usage.input_tokens
                self.token_counts['output'] += usage.output_tokens
                self.token_counts['cache_read'] += usage.cache_read_input_tokens
                self.token_counts['cache_creation'] += usage.cache_creation_input_tokens

            return {
                #将上下文附加到原始文本块
                'text_to_embed': f&quot;{chunk['content']}\n\n{contextualized_text}&quot;,
                'metadata': {
                    'doc_id': doc['doc_id'],
                    'original_uuid': doc['original_uuid'],
                    'chunk_id': chunk['chunk_id'],
                    'original_index': chunk['original_index'],
                    'original_content': chunk['content'],
                    'contextualized_content': contextualized_text
                }
            }

        print(f&quot;Processing {total_chunks} chunks with {parallel_threads} threads&quot;)
        with ThreadPoolExecutor(max_workers=parallel_threads) as executor:
            futures = []
            for doc in dataset:
                for chunk in doc['chunks']:
                    futures.append(executor.submit(process_chunk, doc, chunk))

            for future in tqdm(as_completed(futures), total=total_chunks, desc=&quot;Processing chunks&quot;):
                result = future.result()
                texts_to_embed.append(result['text_to_embed'])
                metadata.append(result['metadata'])

        self._embed_and_store(texts_to_embed, metadata)
        self.save_db()

        #记录令牌使用情况
        print(f&quot;Contextual Vector database loaded and saved. Total chunks processed: {len(texts_to_embed)}&quot;)
        print(f&quot;Total input tokens without caching: {self.token_counts['input']}&quot;)
        print(f&quot;Total output tokens: {self.token_counts['output']}&quot;)
        print(f&quot;Total input tokens written to cache: {self.token_counts['cache_creation']}&quot;)
        print(f&quot;Total input tokens read from cache: {self.token_counts['cache_read']}&quot;)

        total_tokens = self.token_counts['input'] + self.token_counts['cache_read'] + self.token_counts['cache_creation']
        savings_percentage = (self.token_counts['cache_read'] / total_tokens) * 100 if total_tokens &gt; 0 else 0
        print(f&quot;Total input token savings from prompt caching: {savings_percentage:.2f}% of all input tokens used were read from cache.&quot;)
        print(&quot;Tokens read from cache come at a 90 percent discount!&quot;)

    #我们在这里使用voyage AI进行嵌入。在此处阅读更多信息：https://docs.voyageai.com/docs/embeddings
    def _embed_and_store(self, texts: List[str], data: List[Dict[str, Any]]):
        batch_size = 128
        result = [
            self.voyage_client.embed(
                texts[i : i + batch_size],
                model=&quot;voyage-2&quot;
            ).embeddings
            for i in range(0, len(texts), batch_size)
        ]
        self.embeddings = [embedding for batch in result for embedding in batch]
        self.metadata = data

    def search(self, query: str, k: int = 20) -&gt; List[Dict[str, Any]]:
        if query in self.query_cache:
            query_embedding = self.query_cache[query]
        else:
            query_embedding = self.voyage_client.embed([query], model=&quot;voyage-2&quot;).embeddings[0]
            self.query_cache[query] = query_embedding

        if not self.embeddings:
            raise ValueError(&quot;No data loaded in the vector database.&quot;)

        similarities = np.dot(self.embeddings, query_embedding)
        top_indices = np.argsort(similarities)[::-1][:k]

        top_results = []
        for idx in top_indices:
            result = {
                &quot;metadata&quot;: self.metadata[idx],
                &quot;similarity&quot;: float(similarities[idx]),
            }
            top_results.append(result)
        return top_results

    def save_db(self):
        data = {
            &quot;embeddings&quot;: self.embeddings,
            &quot;metadata&quot;: self.metadata,
            &quot;query_cache&quot;: json.dumps(self.query_cache),
        }
        os.makedirs(os.path.dirname(self.db_path), exist_ok=True)
        with open(self.db_path, &quot;wb&quot;) as file:
            pickle.dump(data, file)

    def load_db(self):
        if not os.path.exists(self.db_path):
            raise ValueError(&quot;Vector database file not found. Use load_data to create a new database.&quot;)
        with open(self.db_path, &quot;rb&quot;) as file:
            data = pickle.load(file)
        self.embeddings = data[&quot;embeddings&quot;]
        self.metadata = data[&quot;metadata&quot;]
        self.query_cache = json.loads(data[&quot;query_cache&quot;])
</code></pre>

<pre class="codehilite"><code class="language-python"># Load the transformed dataset
with open('data/codebase_chunks.json', 'r') as f:
    transformed_dataset = json.load(f)

# Initialize the ContextualVectorDB
contextual_db = ContextualVectorDB(&quot;my_contextual_db&quot;)

# Load and process the data
#注意：考虑增加并行线程数以加快运行速度，或减少并行线程数以避免达到API速率限制
contextual_db.load_data(transformed_dataset, parallel_threads=5)
</code></pre>

<pre class="codehilite"><code>Processing 737 chunks with 5 threads


Processing chunks: 100%|██████████| 737/737 [02:37&lt;00:00,  4.69it/s]


Contextual Vector database loaded and saved. Total chunks processed: 737
Total input tokens without caching: 500383
Total output tokens: 40318
Total input tokens written to cache: 341422
Total input tokens read from cache: 2825073
Total input token savings from prompt caching: 77.04% of all input tokens used were read from cache.
Tokens read from cache come at a 90 percent discount!
</code></pre>

<pre class="codehilite"><code class="language-python">r5 = evaluate_db(contextual_db, 'data/evaluation_set.jsonl', 5)
r10 = evaluate_db(contextual_db, 'data/evaluation_set.jsonl', 10)
r20 = evaluate_db(contextual_db, 'data/evaluation_set.jsonl', 20)
</code></pre>

<pre class="codehilite"><code>Evaluating retrieval: 100%|██████████| 248/248 [00:06&lt;00:00, 39.53it/s]


Pass@5: 86.37%
Total Score: 0.8637192780337941
Total queries: 248


Evaluating retrieval: 100%|██████████| 248/248 [00:06&lt;00:00, 40.05it/s]


Pass@10: 92.81%
Total Score: 0.9280913978494625
Total queries: 248


Evaluating retrieval: 100%|██████████| 248/248 [00:06&lt;00:00, 39.64it/s]

Pass@20: 93.78%
Total Score: 0.9378360215053763
Total queries: 248
</code></pre>

<h2 id="_8">添加重新排序步骤</h2>
<p>如果您想进一步提高性能，我们建议添加重新排序步骤。在使用重新排序器时，您可以从向量存储中检索更多文档，然后使用重新排序器从这些文档中选择一个子集。一种常见的技术是将重新排序作为实现高精度混合搜索的方法。您可以在初始检索步骤中使用语义搜索和基于关键字的搜索的组合（如本指南前面所述），然后使用重新排序步骤从语义搜索和关键字搜索系统返回的文档组合列表中仅选择k个最相关的文档。</p>
<p>下面，我们将仅演示重新排序步骤（暂时跳过混合搜索技术）。您会看到，我们检索的文档数量是我们希望检索的最终k个文档数量的10倍，然后使用Cohere的重新排序模型从该列表中选择10个最相关的结果。添加重新排序步骤可带来适度的额外性能提升。在我们的例子中，Pass@10从92.81%提高到94.79%。</p>
<pre class="codehilite"><code class="language-python">import cohere
from typing import List, Dict, Any, Callable
import json
from tqdm import tqdm

def load_jsonl(file_path: str) -&gt; List[Dict[str, Any]]:
    with open(file_path, 'r') as file:
        return [json.loads(line) for line in file]

def chunk_to_content(chunk: Dict[str, Any]) -&gt; str:
    original_content = chunk['metadata']['original_content']
    contextualized_content = chunk['metadata']['contextualized_content']
    return f&quot;{original_content}\n\nContext: {contextualized_content}&quot; 

def retrieve_rerank(query: str, db, k: int) -&gt; List[Dict[str, Any]]:
    co = cohere.Client( os.getenv(&quot;COHERE_API_KEY&quot;))

    #检索比我们通常检索的更多的结果
    semantic_results = db.search(query, k=k*10)

    #提取用于重新排序的文档，使用上下文化的内容
    documents = [chunk_to_content(res) for res in semantic_results]

    response = co.rerank(
        model=&quot;rerank-english-v3.0&quot;,
        query=query,
        documents=documents,
        top_n=k
    )
    time.sleep(0.1)

    final_results = []
    for r in response.results:
        original_result = semantic_results[r.index]
        final_results.append({
            &quot;chunk&quot;: original_result['metadata'],
            &quot;score&quot;: r.relevance_score
        })

    return final_results

def evaluate_retrieval_rerank(queries: List[Dict[str, Any]], retrieval_function: Callable, db, k: int = 20) -&gt; Dict[str, float]:
    total_score = 0
    total_queries = len(queries)

    for query_item in tqdm(queries, desc=&quot;Evaluating retrieval&quot;):
        query = query_item['query']
        golden_chunk_uuids = query_item['golden_chunk_uuids']

        golden_contents = []
        for doc_uuid, chunk_index in golden_chunk_uuids:
            golden_doc = next((doc for doc in query_item['golden_documents'] if doc['uuid'] == doc_uuid), None)
            if golden_doc:
                golden_chunk = next((chunk for chunk in golden_doc['chunks'] if chunk['index'] == chunk_index), None)
                if golden_chunk:
                    golden_contents.append(golden_chunk['content'].strip())

        if not golden_contents:
            print(f&quot;警告：未找到查询的黄金内容：{query}&quot;)
            continue

        retrieved_docs = retrieval_function(query, db, k)

        chunks_found = 0
        for golden_content in golden_contents:
            for doc in retrieved_docs[:k]:
                retrieved_content = doc['chunk']['original_content'].strip()
                if retrieved_content == golden_content:
                    chunks_found += 1
                    break

        query_score = chunks_found / len(golden_contents)
        total_score += query_score

    average_score = total_score / total_queries
    pass_at_n = average_score * 100
    return {
        &quot;pass_at_n&quot;: pass_at_n,
        &quot;average_score&quot;: average_score,
        &quot;total_queries&quot;: total_queries
    }

def evaluate_db_advanced(db, original_jsonl_path, k):
    original_data = load_jsonl(original_jsonl_path)

    def retrieval_function(query, db, k):
        return retrieve_rerank(query, db, k)

    results = evaluate_retrieval_rerank(original_data, retrieval_function, db, k)
    print(f&quot;Pass@{k}: {results['pass_at_n']:.2f}%&quot;)
    print(f&quot;Average Score: {results['average_score']}&quot;)
    print(f&quot;Total queries: {results['total_queries']}&quot;)
    return results
</code></pre>

<pre class="codehilite"><code class="language-python">results5 = evaluate_db_advanced(contextual_db, 'data/evaluation_set.jsonl', 5)
results10 = evaluate_db_advanced(contextual_db, 'data/evaluation_set.jsonl', 10)
results20 = evaluate_db_advanced(contextual_db, 'data/evaluation_set.jsonl', 20)
</code></pre>

<pre class="codehilite"><code>Evaluating retrieval: 100%|██████████| 248/248 [01:22&lt;00:00,  2.99it/s]


Pass@5: 91.24%
Average Score: 0.912442396313364
Total queries: 248


Evaluating retrieval: 100%|██████████| 248/248 [01:34&lt;00:00,  2.63it/s]


Pass@10: 94.79%
Average Score: 0.9479166666666667
Total queries: 248


Evaluating retrieval: 100%|██████████| 248/248 [02:08&lt;00:00,  1.93it/s]

Pass@20: 96.30%
Average Score: 0.9630376344086022
Total queries: 248
</code></pre>

<h3 id="_9">后续步骤和关键要点</h3>
<p>1) 我们演示了如何使用上下文嵌入来提高检索性能，然后通过上下文BM25和重新排序进行了进一步改进。</p>
<p>2) 此示例使用了代码库，但这些方法也适用于其他数据类型，如内部公司知识库、财务与法律内容、教育内容等。 </p>
<p>3) 如果您是AWS用户，可以从<code>contextual-rag-lambda-function</code>中的Lambda函数开始，如果您是GCP用户，可以启动自己的Cloud Run实例并遵循类似的模式！</p>
            </article>
            
            <nav class="page-nav"><a href="skills/text_to_sql/guide_zh.html" class="nav-link prev">← Set your Anthropic API key</a><a href="third_party/VoyageAI/how_to_create_embeddings_zh.html" class="nav-link next">这将自动使用环境变量VOYAGE_API_KEY。 →</a></nav>
        </main>
    </div>
</body>
</html>